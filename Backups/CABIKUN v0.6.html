<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CABI-KUN</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <style>
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        /* Custom styles for UI components based on user request */
        .interactive-button { transition: all 0.2s ease-in-out; }
        .interactive-button:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .interactive-button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* New Active Nav Link Style */
        .nav-link-active {
            background-image: linear-gradient(to right, #10b981, #22c55e); /* from-green-500 to-emerald-500 */
        }

        /* Toggle Switch styles */
        .toggle-input:checked ~ .dot { transform: translateX(100%); }
        /* Updated toggle background to gradient */
        .toggle-input:checked ~ .toggle-bg { 
            background-image: linear-gradient(to right, #10b981, #22c55e); /* from-green-500 to-emerald-500 */
        }

        /* Tabs styles */
        .component-tab-btn.active { border-color: #22c55e; color: #059669; font-weight: 600; } /* emerald-500 / emerald-700 */
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }
        
        /* Side Peek Panel */
        #template-side-peek {
            transition: transform 0.3s ease-in-out;
            transform: translateX(100%);
        }
        #template-side-peek.open {
            transform: translateX(0);
        }

        /* Loading Spinner */
        .loader {
            border: 4px solid #f3f3ff; /* Light grey */
            border-top: 4px solid #10b981; /* green-500 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Loading Overlay */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        /* Drag and Drop styles */
        .drop-zone {
            min-height: 200px;
            border: 2px dashed #d1d5db;
            background-color: #f9fafb;
            padding: 8px;
            border-radius: 8px;
        }
        .draggable-item {
            padding: 8px 12px;
            margin-bottom: 4px;
            background-color: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            cursor: grab;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        /* Style for dimension/measure pills in custom report modal */
        .draggable-item[data-type="dimension"] {
            background-color: #f0fdf4; /* green-50 */
            border-color: #bbf7d0; /* green-200 */
            color: #15803d; /* green-700 */
        }
        .draggable-item[data-type="measure"] {
            background-color: #f0f9ff; /* sky-50 */
            border-color: #bae6fd; /* sky-200 */
            color: #0369a1; /* sky-700 */
        }

        .sortable-ghost {
            background-color: #dbeafe;
            opacity: 0.7;
        }

        /* --- Flatpickr Green Theme --- */
        .flatpickr-calendar {
            border-radius: 8px;
            border: 1px solid #d1d5db; /* gray-300 */
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .flatpickr-month {
            color: #059669; /* emerald-700 */
        }
        .flatpickr-weekday {
            color: #047857; /* emerald-800 */
            font-weight: 600;
        }
        .flatpickr-day.selected,
        .flatpickr-day.startRange,
        .flatpickr-day.endRange,
        .flatpickr-day.selected.inRange,
        .flatpickr-day.startRange.inRange,
        .flatpickr-day.endRange.inRange {
            /* The main gradient */
            background: linear-gradient(to right, #10b981, #22c55e); /* from-emerald-500 to-green-500 */
            border-color: #059669; /* emerald-700 */
            color: #fff;
        }
        .flatpickr-day:hover,
        .flatpickr-day:focus {
            background: #d1fae5; /* green-100 */
            border-color: #d1fae5; /* green-100 */
            color: #065f46; /* green-900 */
        }
        .flatpickr-day.inRange {
            background: #ecfdf5; /* green-50 */
            border-color: #ecfdf5; /* Match background */
            box-shadow: -5px 0 0 #ecfdf5, 5px 0 0 #ecfdf5;
            color: #065f46; /* green-900 */
        }
        /* Fix hover on selected */
        .flatpickr-day.selected:hover,
        .flatpickr-day.startRange:hover,
        .flatpickr-day.endRange:hover {
            background: linear-gradient(to right, #059669, #10b981); /* Darker gradient */
            color: #fff;
        }
        /* Arrow colors */
        .flatpickr-prev-month svg,
        .flatpickr-next-month svg {
            fill: #059669; /* emerald-700 */
        }
        .flatpickr-prev-month:hover svg,
        .flatpickr-next-month:hover svg {
            fill: #065f46; /* emerald-900 */
        }
        
        /* --- Column Resize Styles --- */
        .resize-handle {
            position: absolute;
            top: 0;
            right: 0;
            width: 5px;
            height: 100%;
            cursor: col-resize;
            user-select: none;
            background-color: transparent;
            transition: background-color 0.2s;
        }
        .resize-handle:hover,
        body.resizing .resize-handle {
            background-color: #22c55e; /* green-500 */
        }
        body.resizing {
            cursor: col-resize !important;
            user-select: none;
        }
        /* Ensure table layout is fixed for resizing to work well */
        #custom-report-table, #comparison-table-pivot, #comparison-table-flat {
            table-layout: fixed;
        }
        /* --- Style for report table cells --- */
        #custom-report-table td, #comparison-table-pivot td, #comparison-table-flat td {
            overflow: hidden;         /* Hide overflowing content */
            text-overflow: ellipsis;  /* Show ... for truncated text */
            white-space: nowrap;      /* Prevent text wrapping */
        }
        
        /* --- Custom Select Styling --- */
        .custom-select {
            appearance: none; /* Remove default arrow */
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%2310b981' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E"); /* Green arrow */
            background-repeat: no-repeat;
            background-position: right 0.5rem center; /* Position arrow */
            background-size: 1.25em; /* Arrow size */
            padding-right: 2.5rem; /* Make space for arrow */
        }
        /* Adjust focus ring color */
        .custom-select:focus {
             outline: none; /* Remove default outline */
             border-color: #10b981; /* green-500 */
             box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.5); /* green-500 with opacity */
        }
        
        /* Custom styles for the Filter Button */
        .filter-button-default {
            /* Default white button style */
            background-color: white;
            color: #475569; /* slate-600 */
            border: 1px solid #cbd5e1; /* slate-300 */
        }
        .filter-button-default:hover {
            background-color: #f8fafc; /* slate-50 */
        }
        
        .filter-button-active {
            /* Active gradient style */
            background-image: linear-gradient(to right, #10b981, #22c55e); /* from-green-500 to-emerald-500 */
            color: white;
            border: none;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); /* green-500 shadow */
        }

        /* --- NEW: Hide number input arrows/spinners for target input --- */
        #target-value-input::-webkit-outer-spin-button,
        #target-value-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        #target-value-input {
            -moz-appearance: textfield; /* Firefox */
            border-left: 1px solid #cbd5e1; /* slate-300 separator */
        }
        /* Ensure select within the container removes its individual borders and only shows focus ring from parent */
        #target-setting-container select {
            border: none !important;
            background-color: white;
            padding-left: 12px; /* px-3 */
            padding-right: 2.5rem; /* Make space for arrow */
            outline: none;
        }

        /* Style for disabled date filter input in header */
        .date-filter-disabled {
            opacity: 0.5;
            pointer-events: none;
            cursor: default !important;
            background-color: #f1f5f9; /* slate-100 */
        }

        /* --- NEW: Sort Indicator Styles --- */
        .sort-indicator {
            display: inline-block;
            margin-left: 6px;
            color: #9ca3af; /* gray-400 */
            opacity: 0.5;
            transition: opacity 0.2s;
        }
        th.sortable-header.active .sort-indicator {
            color: #10b981; /* green-500 */
            opacity: 1;
        }
    </style>
</head>
<body class="bg-slate-100 font-sans text-slate-800">

    <div id="loading-overlay">
        <div class="loader"></div>
        <p id="loading-text" class="mt-4 font-semibold text-slate-600">Loading...</p>
    </div>

    <div id="main-app-container" class="flex h-screen overflow-hidden" style="display: none;">
        <aside class="w-64 bg-white shadow-md flex flex-col shrink-0">
            <div class="p-4 border-b">
                <h1 class="text-xl font-bold bg-gradient-to-r from-green-500 to-emerald-500 bg-clip-text text-transparent" data-i18n="appTitle">CABI君</h1>
            </div>
            <nav class="flex-1 overflow-y-auto">
                <ul class="p-2 space-y-1" id="nav-menu">
                    <li><a href="#home" class="nav-link flex items-center gap-3 px-4 py-2.5 rounded-lg text-slate-700 hover:bg-slate-100 font-semibold" data-page="home-page"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg><span data-i18n="navHome">ホーム</span></a></li>
                    <li><a href="#dashboard" class="nav-link dashboard-nav-link flex items-center gap-3 px-4 py-2.5 rounded-lg text-slate-700 hover:bg-slate-100 font-semibold" data-page="dashboard-page"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><rect width="7" height="9" x="3" y="3" rx="1"></rect><rect width="7" height="5" x="14" y="3" rx="1"></rect><rect width="7" height="9" x="14" y="12" rx="1"></rect><rect width="7" height="5" x="3" y="16" rx="1"></rect></svg><span data-i18n="navDashboard">サマリー</span></a></li>
                    <li><a href="#daily" class="nav-link dashboard-nav-link flex items-center gap-3 px-4 py-2.5 rounded-lg text-slate-700 hover:bg-slate-100 font-semibold" data-page="daily-page"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"></rect><line x1="16" x2="16" y1="2" y2="6"></line><line x1="8" x2="8" y1="2" y2="6"></line><line x1="3" x2="21" y1="10" y2="10"></line><path d="M8 14h.01"></path><path d="M12 14h.01"></path><path d="M16 14h.01"></path><path d="M8 18h.01"></path><path d="M12 18h.01"></path><path d="M16 18h.01"></path></svg><span data-i18n="navDaily">日別</span></a></li>
                    <li><a href="#comparison" class="nav-link dashboard-nav-link flex items-center gap-3 px-4 py-2.5 rounded-lg text-slate-700 hover:bg-slate-100 font-semibold" data-page="comparison-page"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><circle cx="18" cy="18" r="3"></circle><circle cx="6" cy="6" r="3"></circle><path d="M13 6h3a2 2 0 0 1 2 2v7"></path><path d="M11 18H8a2 2 0 0 1-2-2V9"></path></svg><span data-i18n="navComparison">期間比較</span></a></li>
                    <li><a href="#custom" class="nav-link dashboard-nav-link flex items-center gap-3 px-4 py-2.5 rounded-lg text-slate-700 hover:bg-slate-100 font-semibold" data-page="custom-page"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><line x1="4" y1="21" x2="4" y2="14"></line><line x1="4" y1="10" x2="4" y2="3"></line><line x1="12" y1="21" x2="12" y2="12"></line><line x1="12" y1="8" x2="12" y2="3"></line><line x1="20" y1="21" x2="20" y2="16"></line><line x1="20" y1="12" x2="20" y2="3"></line><line x1="1" y1="14" x2="7" y2="14"></line><line x1="9" y1="8" x2="15" y2="8"></line><line x1="17" y1="16" x2="23" y2="16"></line></svg><span data-i18n="navCustom">カスタムレポート</span></a></li>
                </ul>
            </nav>
            <div class="p-4 border-t">
                <div class="flex items-center justify-center space-x-4">
                    <div class="flex items-center justify-center space-x-2">
                        <span class="font-medium text-sm">JA</span>
                        <label class="flex items-center cursor-pointer">
                            <div class="relative">
                                <input type="checkbox" id="language-toggle" class="sr-only toggle-input">
                                <div class="block bg-slate-200 w-12 h-7 rounded-full toggle-bg"></div> <div class="dot absolute left-1 top-1 bg-white w-5 h-5 rounded-full transition-transform"></div>
                            </div>
                        </label>
                        <span class="font-medium text-sm">EN</span>
                    </div>
                    
                    <div class="flex items-center justify-center space-x-2">
                        <button id="currency-toggle-btn" class="interactive-button w-12 h-7 rounded-full bg-slate-200 text-sm font-bold text-slate-700 flex items-center justify-center" data-currency="JPY">
                            ¥
                        </button>
                    </div>
                </div>
            </div>
        </aside>

        <main class="flex-1 flex flex-col overflow-hidden relative">
            <header id="dashboard-header" class="p-4 flex justify-end items-center gap-4 bg-slate-100 border-b hidden">
                
                <button id="open-filter-modal-btn" class="interactive-button px-4 py-2 font-semibold rounded-lg flex items-center gap-2 filter-button-default" data-is-active="false">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>
                    <span data-i18n="headerFilterLabel">Filter</span>
                    <span id="filter-count-badge" class="ml-1 px-2 py-0.5 text-xs font-bold rounded-full bg-white text-green-600 hidden">0</span>
                </button>

                <div class="flex items-center gap-2">
                    <label for="target-measure-select" class="font-semibold text-sm text-slate-600" data-i18n="headerTargetMeasureLabel">目標:</label>
                    
                    <div id="target-setting-container" class="flex bg-white border-2 border-slate-300 rounded-lg focus-within:ring-2 focus-within:ring-green-500 focus-within:border-green-500 transition-all duration-150">
                        <select id="target-measure-select" class="custom-select text-slate-700 text-sm block w-32 focus:ring-0 focus:border-0 rounded-l-md">
                            </select>
                        <input type="number" id="target-value-input" placeholder="Value" min="0" class="w-24 px-3 py-1.5 text-sm bg-white focus:outline-none focus:ring-0 rounded-r-md">
                    </div>
                </div>

                <div id="header-date-filter-container" class="relative flex items-center gap-2 cursor-pointer hover:bg-slate-200 p-2 rounded-lg">
                     <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 text-slate-500"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"></rect><line x1="16" x2="16" y1="2" y2="6"></line><line x1="8" x2="8" y1="2" y2="6"></line><line x1="3" x2="21" y1="10" y2="10"></line></svg>
                    <span id="date-range-display" class="font-semibold text-slate-600"></span>
                    <input type="text" id="header-date-filter-input" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                </div>

                <div id="comparison-date-filter-container" class="relative flex items-center gap-2 cursor-pointer hover:bg-slate-200 p-2 rounded-lg date-filter-disabled">
                     <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 text-slate-500"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"></rect><line x1="16" x2="16" y1="2" y2="6"></line><line x1="8" x2="8" y1="2" y2="6"></line><line x1="3" x2="21" y1="10" y2="10"></line></svg>
                    <span id="comparison-date-range-display" class="font-semibold text-slate-600" data-i18n="headerComparisonPeriod">比較期間</span>
                    <input type="text" id="comparison-date-filter-input" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" disabled>
                </div>

            </header>
            <div class="flex-1 overflow-y-auto p-4 md:p-8">
                <div id="app-content">
                    <div id="home-page" class="app-page">
                        <div class="max-w-4xl mx-auto space-y-8">
                            <div class="text-center">
                                <h2 class="text-3xl font-bold" data-i18n="homeTitle">データ分析を始めよう</h2>
                                <p class="text-slate-500 mt-2" data-i18n="homeSubtitle">CSVファイルをアップロードし、テンプレートを選択または作成してください。</p>
                            </div>

                            <div class="p-1 bg-gradient-to-r from-green-500 to-emerald-500 rounded-xl shadow-lg">
                                <div class="bg-white rounded-lg p-6">
                                    <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                                        <span class="bg-green-500 text-white rounded-full h-7 w-7 flex items-center justify-center font-bold">1</span>
                                        <span data-i18n="homeUploadTitle">CSVファイルをアップロード</span>
                                    </h3>
                                    <input type="file" id="csv-files-input" multiple class="hidden" accept=".csv">
                                    <div class="flex items-center gap-4">
                                        <button id="select-files-btn" class="interactive-button px-5 py-2.5 font-semibold rounded-lg bg-white text-slate-700 border border-slate-300 hover:bg-slate-50" data-i18n="homeSelectFiles">ファイルを選択</button>
                                    </div>
                                    
                                    <p id="file-header-warning" class="text-xs text-yellow-700 bg-yellow-50 p-2 rounded-lg mt-3"></p>
                                    
                                    <div id="file-list" class="mt-4 text-left text-sm space-y-2"></div>
                                    <div id="processing-status" class="mt-2 text-sm font-semibold"></div>
                                    <div class="text-right mt-2">
                                        <button id="manage-files-btn" class="text-sm text-green-600 hover:underline hidden" data-i18n="homeManageFiles">選択したファイルを管理</button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="p-1 bg-gradient-to-r from-green-500 to-emerald-500 rounded-xl shadow-lg">
                                <div class="bg-white rounded-lg p-6">
                                    <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                                        <span class="bg-green-500 text-white rounded-full h-7 w-7 flex items-center justify-center font-bold">2</span>
                                        <span data-i18n="homeTemplateFolderTitle">テンプレート管理</span>
                                    </h3>
                                    <input type="file" id="template-files-input" class="hidden" accept=".json">
                                    <div class="flex items-center gap-4">
                                        <button id="load-templates-btn" class="interactive-button px-5 py-2.5 font-semibold rounded-lg bg-white text-slate-700 border border-slate-300 hover:bg-slate-50" data-i18n="homeSelectFolder">テンプレートを読み込む</button>
                                        <button id="create-template-btn" class="interactive-button px-5 py-2.5 font-semibold rounded-lg bg-white text-slate-700 border border-slate-300 hover:bg-slate-50" data-i18n="homeCreateTemplate">新規テンプレート作成</button>
                                    </div>
                                    <div id="template-list" class="mt-4 space-y-2"></div>
                                </div>
                            </div>

                            <div class="p-1 bg-gradient-to-r from-green-500 to-emerald-500 rounded-xl shadow-lg">
                                <div class="bg-white rounded-lg p-6">
                                    <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                                        <span class="bg-green-500 text-white rounded-full h-7 w-7 flex items-center justify-center font-bold">3</span>
                                        <span data-i18n="homeActionTitle">アクション</span>
                                    </h3>
                                    <div class="flex items-center gap-4">
                                        <button id="start-analysis-btn" class="interactive-button px-5 py-2.5 font-semibold rounded-lg bg-gradient-to-r from-green-500 to-emerald-500 text-white shadow-md hover:opacity-90" data-i18n="homeStartAnalysis">分析を開始</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="dashboard-wrapper" class="hidden">
                        <div id="dashboard-page" class="app-page hidden"></div>
                        <div id="daily-page" class="app-page hidden"></div>
                        <div id="comparison-page" class="app-page hidden">
                            <div class="p-1 bg-gradient-to-r from-green-500 to-emerald-500 rounded-xl shadow-lg mb-6">
                                <div class="bg-white p-6 rounded-lg">
                                    <div class="flex justify-between items-center mb-4">
                                        <h2 class="text-xl font-bold" data-i18n="comparisonTitle">期間比較レポート</h2>
                                        <button id="customize-comparison-btn" class="interactive-button px-4 py-2 font-semibold rounded-lg bg-white text-slate-700 border border-slate-300 hover:bg-slate-50 flex items-center gap-2">
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><polygon points="14 2 18 6 7 17 3 17 3 13 14 2"></polygon><line x1="3" y1="22" x2="21" y2="22"></line></svg>
                                            <span data-i18n="customReportCustomize">表示項目を編集</span>
                                        </button>
                                    </div>
                                    
                                    <div class="flex items-center justify-between gap-4 mb-4">
                                        <!-- Instructions will be injected here by JS -->
                                        <p class="text-sm text-slate-600" data-i18n-html="comparisonUsageNote"></p>
                                        <div>
                                            <button id="toggle-comparison-view-btn" class="interactive-button px-4 py-2 font-semibold rounded-lg bg-white text-slate-700 border border-slate-300 hover:bg-slate-50 flex items-center gap-2">
                                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><rect x="3" y="3" width="7" height="7" rx="1"></rect><rect x="14" y="3" width="7" height="7" rx="1"></rect><rect x="14" y="14" width="7" height="7" rx="1"></rect><rect x="3" y="14" width="7" height="7" rx="1"></rect></svg>
                                                <span data-i18n="comparisonViewPivot">ピボット表示</span>
                                            </button>
                                        </div>
                                    </div>
                                    <div id="comparison-report-table-container" class="overflow-x-auto">
                                        </div>
                                </div>
                            </div>
                        </div>
                        <div id="custom-page" class="app-page hidden"></div>
                    </div>
                </div>
            </div>

            <div id="template-side-peek" class="fixed top-0 right-0 h-full w-80 bg-white shadow-2xl z-40 p-6 overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h3 id="side-peek-title" class="text-lg font-bold">Template Details</h3>
                    <button id="close-side-peek-btn" class="p-1 rounded-full hover:bg-slate-200">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>
                <div id="side-peek-content" class="space-y-4"></div>
            </div>
        </main>
    </div>
    
    <div id="filter-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-lg w-full max-w-lg max-h-[90vh] flex flex-col">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold" data-i18n="modalFilterTitle">Filters</h3>
                <button id="close-filter-modal-btn" class="p-1 rounded-full hover:bg-slate-200">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 text-slate-500"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div class="p-6 flex-1 overflow-y-auto space-y-4">
                <div id="dynamic-filters-container" class="space-y-4">
                    <div id="active-filters-list" class="space-y-2">
                        </div>

                    <div class="border rounded-lg p-3 bg-slate-50">
                        <h4 class="font-semibold mb-3 text-slate-700" data-i18n="modalAddNewFilter">Add New Filter</h4>
                        <div class="grid grid-cols-1 sm:grid-cols-4 gap-3">
                            <select id="filter-dimension-select" class="custom-select w-full px-3 py-2.5 rounded-lg border-2 border-slate-300 focus:ring-green-500 focus:border-green-500 text-sm">
                                <option value="" disabled selected>Select Dimension</option>
                            </select>

                            <select id="filter-condition-select" class="custom-select w-full px-3 py-2.5 rounded-lg border-2 border-slate-300 focus:ring-green-500 focus:border-green-500 text-sm">
                                <option value="contains">contains</option>
                                <option value="not_contains">does not contain</option>
                                <option value="exact_match">is equal to (case sensitive)</option>
                                <option value="not_exact_match">is not equal to (case sensitive)</option>
                                <option value="starts_with">starts with</option>
                                <option value="ends_with">ends with</option>
                            </select>

                            <input type="text" id="filter-value-input" placeholder="Enter value (one per line)" class="col-span-1 sm:col-span-2 w-full px-3 py-2.5 rounded-lg border-2 border-slate-300 focus:ring-green-500 focus:border-green-500 text-sm">
                        </div>
                        <div class="text-right mt-3">
                            <button id="add-new-filter-btn" class="interactive-button px-4 py-2 font-semibold rounded-lg bg-green-500 text-white shadow-md hover:opacity-90 disabled:opacity-50" disabled>Add Filter</button>
                        </div>
                    </div>
                </div>
            </div>
             <div class="p-4 border-t flex justify-between items-center">
                <button id="reset-filters-btn" class="interactive-button px-5 py-2.5 font-semibold rounded-lg bg-white text-slate-700 border border-slate-300 hover:bg-slate-50" data-i18n="filterReset">リセット</button>
                <button id="apply-filters-btn" class="interactive-button px-5 py-2.5 font-semibold rounded-lg bg-gradient-to-r from-green-500 to-emerald-500 text-white shadow-md hover:opacity-90" data-i18n="filterApply">適用</button>
            </div>
        </div>
    </div>


    <div id="csv-files-side-peek" class="fixed top-0 right-0 h-full w-80 bg-white shadow-2xl z-40 p-6 overflow-y-auto" style="transform: translateX(100%); transition: transform 0.3s ease-in-out;">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-lg font-bold" data-i18n="csvPeekTitle">アップロードされたファイル</h3>
            <button id="close-csv-peek-btn" class="p-1 rounded-full hover:bg-slate-200">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
        <div id="csv-peek-content" class="space-y-2"></div>
    </div>

    <div id="create-template-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-lg w-full max-w-4xl max-h-[90vh] flex flex-col">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold" data-i18n="modalCreateTitle">新規テンプレート作成</h3>
                 <button id="cancel-create-template-btn" class="p-1 rounded-full hover:bg-slate-200">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 text-slate-500"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div class="p-6 flex-1 overflow-y-auto space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                     <div>
                        <label for="template-name" class="font-semibold text-sm mb-1 block" data-i18n="modalTemplateName">テンプレート名</label>
                        <input type="text" id="template-name" class="w-full px-4 py-2.5 rounded-lg border-2 border-slate-300 focus:ring-2 focus:ring-green-500 focus:border-green-500" data-i18n-placeholder="modalTemplateNamePlaceholder">
                        <div id="template-name-error" class="text-red-500 text-sm mt-1 hidden"></div>
                    </div>
                     <div>
                        <label for="template-date-column" class="font-semibold text-sm mb-1 block" data-i18n="modalDateColumn">日付列 (必須)</label>
                        <select id="template-date-column" class="w-full px-4 py-2.5 rounded-lg border-2 border-slate-300 focus:ring-2 focus:ring-green-500 focus:border-green-500">
                            </select>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                         <h4 class="font-bold mb-2 text-center text-sm text-slate-600" data-i18n="modalAvailableColumns">利用可能な列</h4>
                         <input type="text" id="column-search-input" class="w-full px-3 py-2 mb-2 rounded-lg border-2 border-slate-300 focus:ring-2 focus:ring-green-500" data-i18n-placeholder="searchColumnsPlaceholder">
                         <div id="available-columns-list" class="drop-zone overflow-y-auto" style="max-height: 280px;"></div>
                    </div>
                    <div>
                         <h4 class="font-bold mb-2 text-center text-sm text-slate-600" data-i18n="modalDimensions">ディメンション (分析軸)</h4>
                         <div id="dimension-columns-dropzone" class="drop-zone"></div>
                    </div>
                    <div>
                        <div class="flex justify-center items-center mb-2">
                            <h4 class="font-bold text-center text-sm text-slate-600 mr-2" data-i18n="modalMeasures">メジャー (数値)</h4>
                            <button id="add-calculated-field-btn" class="text-green-600 hover:text-green-800" title="Add Calculated Field">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>
                            </button>
                        </div>
                         <div id="measure-columns-dropzone" class="drop-zone"></div>
                    </div>
                </div>
            </div>
            <div class="p-4 border-t flex justify-end gap-4">
                <button id="save-template-btn" class="interactive-button px-5 py-2.5 font-semibold rounded-lg bg-gradient-to-r from-green-500 to-emerald-500 text-white shadow-md hover:opacity-90" data-i18n="save">保存</button>
            </div>
        </div>
    </div>
    
     <div id="calculated-field-modal" class="fixed inset-0 bg-black bg-opacity-60 z-[60] hidden items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-lg w-full max-w-md">
             <div class="p-4 border-b flex justify-between items-center">
                <h3 class="text-lg font-bold" data-i18n="modalCalculatedFieldTitle">計算列を作成</h3>
                <button id="cancel-calculated-field-btn" class="p-1 rounded-full hover:bg-slate-200">
                     <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 text-slate-500"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div class="p-6 space-y-4">
                 <div>
                    <label for="calculated-field-name" class="font-semibold text-sm mb-1 block" data-i18n="modalNewColumnName">新しい列名</label>
                    <input type="text" id="calculated-field-name" placeholder="例: クリック単価" class="w-full px-4 py-2.5 rounded-lg border-2 border-slate-300 focus:ring-2 focus:ring-green-500 focus:border-green-500">
                </div>
                <div>
                     <label class="font-semibold text-sm mb-1 block" data-i18n="modalFormula">計算式</label>
                     <div class="flex items-center gap-2">
                        <select id="calc-operand1" class="flex-1 w-full px-3 py-2.5 rounded-lg border-2 border-slate-300"></select>
                        <select id="calc-operator" class="px-3 py-2.5 rounded-lg border-2 border-slate-300">
                            <option value="/">/</option>
                            <option value="*">*</option>
                            <option value="+">+</option>
                            <option value="-">-</option>
                        </select>
                        <select id="calc-operand2" class="flex-1 w-full px-3 py-2.5 rounded-lg border-2 border-slate-300"></select>
                     </div>
                </div>
                <div>
                     <label for="calculated-field-format" class="font-semibold text-sm mb-1 block" data-i18n="modalFormat">フォーマット</label>
                    <select id="calculated-field-format" class="w-full px-3 py-2.5 rounded-lg border-2 border-slate-300">
                        <option value="number" data-i18n="formatNumber">Number</option>
                        <option value="currency" data-i18n="formatCurrency">Currency</option>
                        <option value="percent" data-i18n="formatPercent">Percentage (%)</option>
                        <option value="decimal" data-i18n="formatDecimal">Decimal</option>
                    </select>
                </div>
            </div>
            <div class="p-4 border-t flex justify-end">
                <button id="save-calculated-field-btn" class="interactive-button px-5 py-2.5 font-semibold rounded-lg bg-gradient-to-r from-green-500 to-emerald-500 text-white shadow-md hover:opacity-90" data-i18n="modalAdd">追加</button>
            </div>
        </div>
    </div>

    <div id="custom-report-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-lg w-full max-w-2xl max-h-[90vh] flex flex-col">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold" data-i18n="customReportModalTitle">表示項目を編集</h3>
                 <button id="cancel-custom-report-btn" class="p-1 rounded-full hover:bg-slate-200">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 text-slate-500"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div class="p-6 flex-1 overflow-y-auto space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                         <h4 class="font-bold mb-2 text-center text-sm text-slate-600" data-i18n="customAvailableCols">利用可能な列</h4>
                         <div id="available-columns-list-custom" class="drop-zone overflow-y-auto" style="min-height: 300px; max-height: 400px;">
                            </div>
                    </div>
                    <div>
                         <h4 class="font-bold mb-2 text-center text-sm text-slate-600" data-i18n="customSelectedCols">表示する列</h4>
                         <div id="selected-columns-dropzone-custom" class="drop-zone overflow-y-auto" style="min-height: 300px; max-height: 400px;">
                            </div>
                    </div>
                </div>
            </div>
            <div class="p-4 border-t flex justify-end gap-4">
                <button id="apply-custom-report-btn" class="interactive-button px-5 py-2.5 font-semibold rounded-lg bg-gradient-to-r from-green-500 to-emerald-500 text-white shadow-md hover:opacity-90" data-i18n="customApply">適用</button>
            </div>
        </div>
    </div>

    <div id="comparison-customize-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-lg w-full max-w-2xl max-h-[90vh] flex flex-col">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold" data-i18n="customReportModalTitle">表示項目を編集</h3>
                 <button id="cancel-comparison-customize-btn" class="p-1 rounded-full hover:bg-slate-200">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 text-slate-500"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div class="p-6 flex-1 overflow-y-auto space-y-4">
                <p class="text-sm text-slate-600 mb-4">注意: レポート比較では、ディメンション（分析軸）を **1つだけ** 選択できます。</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                         <h4 class="font-bold mb-2 text-center text-sm text-slate-600" data-i18n="customAvailableCols">利用可能な列</h4>
                         <div id="available-columns-list-comparison" class="drop-zone overflow-y-auto" style="min-height: 300px; max-height: 400px;">
                            </div>
                    </div>
                    <div>
                         <h4 class="font-bold mb-2 text-center text-sm text-slate-600" data-i18n="customSelectedCols">表示する列</h4>
                         <div id="selected-columns-dropzone-comparison" class="drop-zone overflow-y-auto" style="min-height: 300px; max-height: 400px;">
                            </div>
                    </div>
                </div>
            </div>
            <div class="p-4 border-t flex justify-end gap-4">
                <button id="apply-comparison-customize-btn" class="interactive-button px-5 py-2.5 font-semibold rounded-lg bg-gradient-to-r from-green-500 to-emerald-500 text-white shadow-md hover:opacity-90" data-i18n="customApply">適用</button>
            </div>
        </div>
    </div>

    <script type="module">
        // --- Application State ---
        let allData = [];
        let filteredData = [];
        let templateConfig = null;
        let loadedTemplates = [];
        let csvHeaders = [];
        let uploadedFileObjects = [];
        let currentLanguage = 'ja';
        let currentCurrency = 'JPY';
        let charts = {};
        let tempCalculatedFields = []; // Temp storage for calculated fields
        let headerFlatpickr = null;
        let comparisonFlatpickr = null;
        
        // --- Global Target State ---
        let globalTarget = {
             measureName: '',
             value: null
        };
        
        // --- Dimension Filter State ---
        let activeDimensionFilters = []; // e.g., { id: 1, dimension: 'Campaign', condition: 'contains', values: ['Lmt'] }
        let nextFilterId = 1;

        // --- Custom Report State ---
        let customReportConfig = {
            dimensions: [],
            measures: []
        };
        let sortableAvailable = null;
        let sortableSelected = null;
        let customChartInstance = null;
        
        // --- Comparison State & Config ---
        let comparisonState = {
            period2Range: null,
            groupByDimension: null,
            isPivotView: false // Pivot vs. Flat view
        };
        let sortState = {
            column: null,
            direction: 'asc'
        };

        let comparisonChartInstance = null;
        
        // --- Comparison Report Configuration ---
        let comparisonReportConfig = {
            dimensions: [], 
            measures: [],   
            allAvailableMeasures: [] 
        };
        let sortableAvailableComparison = null;
        let sortableSelectedComparison = null;

        // --- NEW: Diverse Pastel Color Palette for Charts ---
        const CHART_COLORS_PASTEL = [
            '#FFADAD', // Pastel Red
            '#FFD6A5', // Pastel Orange
            '#FDFFB6', // Pastel Yellow
            '#CAFFBF', // Pastel Green
            '#9BF6FF', // Pastel Cyan
            '#A0C4FF', // Pastel Blue
            '#BDB2FF', // Pastel Indigo
            '#FFC6FF', // Pastel Magenta
            '#fbb4ae', // Light Coral
            '#b3cde3', // Light Periwinkle
            '#ccebc5', // Tea Green
            '#decbe4', // Light Lavender
            '#fed9a6', // Light Apricot
            '#ffffcc', // Pale Yellow
            '#e5d8bd', // Light Tan
            '#fddaec', // Light Pink
            '#f2f2f2'  // Very Light Gray
        ];

        // --- Helper for "Lower is Better" metrics ---
        // These metrics are generally better when their value is lower (e.g., costs).
        const LOWER_IS_BETTER_KEYWORDS = ['CPA', 'CPI', 'CPC', 'CPM', 'CPO', 'ROAS']; 

        function isLowerIsBetter(measureName) {
            const nameUpper = measureName.toUpperCase();
            
            // Check specific cost/price metrics
            if (LOWER_IS_BETTER_KEYWORDS.some(keyword => nameUpper.includes(keyword))) {
                return true;
            }
            
            // Check generic cost/price terms (Japanese or English)
            if (nameUpper.includes('COST') || nameUpper.includes('費用') || nameUpper.includes('単価')) { // Cost, Hiyou, Tanka
                return true;
            }
            return false;
        }

        // --- Generic Sort Function ---
        function getSortValue(obj, key) {
            const value = obj[key];
            if (typeof value === 'string') {
                // Attempt to parse as a date first
                const date = new Date(value);
                if (!isNaN(date.getTime())) {
                    return date;
                }
                return value.toLowerCase();
            }
            return value;
        }

        // UI Text Translations
        const uiTexts = {
            ja: {
                appTitle: "CABI君",
                navHome: "ホーム", navDashboard: "サマリー", navCustom: "カスタムレポート", navDaily: "日別", navComparison: "期間比較", // NEW
                homeTitle: "データ分析を始めよう", homeSubtitle: "CSVファイルをアップロードし、テンプレートを選択または作成してください。",
                homeUploadTitle: "CSVファイルをアップロード", homeSelectFiles: "ファイルを追加", homeTemplateFolderTitle: "テンプレート管理", 
                homeSelectFolder: "テンプレートを読み込む", homeActionTitle: "アクション", homeCreateTemplate: "新規テンプレート作成", homeStartAnalysis: "分析を開始",
                homeManageFiles: "選択したファイルを管理",
                csvPeekTitle: "アップロードされたファイル",
                filterDateRange: "期間", filterMedia: "媒体", filterCampaign: "キャンペーン", filterAdGroup: "広告グループ",
                filterTargetCPA: "目標CPA",
                filterCampaignPlaceholder: "部分一致で検索", filterAdGroupPlaceholder: "部分一致で検索",
                filterApply: "適用", filterReset: "リセット",
                // NEW: Added for Filter button and Modal
                headerFilterLabel: "フィルター", 
                modalFilterTitle: "フィルター設定",
                headerTargetMeasureLabel: "目標:", 
                modalCreateTitle: "新規テンプレート作成", modalTemplateName: "テンプレート名", modalTemplateNamePlaceholder: "例：月次レポート用",
                modalDimensions: "ディメンション (分析軸)", modalMeasures: "メジャー (数値)",
                modalDateColumn: "日付列 (必須)",
                modalFormat: "フォーマット",
                fileProcessInProgress: "処理中...",
                fileProcessSuccessSingle: "1個のファイルが正常に処理されました。",
                fileProcessSuccessPlural: "{count}個のファイルが正常に処理されました。",
                fileProcessError: "ファイルの処理中にエラーが発生しました: {error}",
                allFilesRemoved: "すべてのファイルが削除されました。",
                noFilesSelected: "ファイルが選択されていません。",
                modalTemplateNameRequired: "テンプレート名を入力してください。",
                searchColumnsPlaceholder: "列を検索...",
                filterAllSelected: "すべて",
                filterItemsSelected: "{count} / {total} 件選択",
                cancel: "キャンセル", save: "保存",
                summaryTrendAnalysis: "トレンド分析",
                summaryPieCost: "{dimension}別費用",
                summaryPieCV: "{dimension}別CV",
                summaryDetailsTitle: "詳細サマリー",
                tableTotal: "合計",
                groupBy: "集計軸：",
                dailyTitle: "日別レポート",
                dailyDateHeader: "日付", 
                formatNumber: "数値",
                formatCurrency: "通貨",
                formatCurrencyJPY: "円 (¥)",
                formatCurrencyUSD: "ドル ($)",
                formatPercent: "パーセント (%)",
                formatDecimal: "小数点",
                // Custom Report
                customReportCustomize: "表示項目を編集",
                customReportModalTitle: "表示項目を編集",
                customAvailableCols: "利用可能な列",
                customSelectedCols: "表示する列",
                customApply: "適用",
                customTableEmpty: "「表示項目を編集」ボタンから、表示したい列（ディメンションまたはメジャー）を少なくとも1つ選択してください。",
                // NEW: Custom Chart
                customChartTitle: "カスタムグラフ",
                customChartDimension: "軸:",
                customChartMeasure1: "指標1:",
                customChartMeasure2: "指標2:",
                customChartType: "グラフ種:",
                customChartTypeBar: "棒グラフ",
                customChartTypeLine: "折れ線グラフ",
                customChartTypePie: "円グラフ",
                customChartNoMeasure: "指標を1つ以上選択してください。",
                customChartNoDimension: "軸を選択してください。",
                // NEW: Filter Conditions (for display, though logic uses English keys)
                filterContains: "次を含む",
                filterNotContains: "次を含まない",
                filterExactMatch: "等しい (大文字/小文字を区別)",
                filterNotExactMatch: "等しくない (大文字/小文字を区別)",
                filterStartsWith: "次から始まる",
                filterEndsWith: "次で終わる",
                // NEW: File upload warning
                fileHeaderWarning: "アップロードされたすべてのファイルは、同じヘッダー構造を持つ必要があります。",
                // NEW: Comparison Page
                headerMainPeriod: "期間 1",
                headerComparisonPeriod: "比較期間",
                comparisonTitle: "期間比較レポート",
                comparisonViewPivot: "ピボット表示",
                comparisonViewFlat: "フラット表示",
                comparisonPeriod1: "期間 1",
                comparisonPeriod2: "期間 2",
                comparisonDifference: "差分",
                comparisonRatio: "比率", // ADDED
                comparisonDifferenceRate: "比率",
                modalAddNewFilter: "新しいフィルターを追加",
                comparisonUsageNote: "<b>使用方法：</b>メイン期間（期間1）と比較期間（期間2）を選択後、「表示項目をカスタマイズ」をクリックして分析軸のディメンション1つと、比較したいメジャーを選択してください。",
                modalCalculatedFieldTitle: "計算列を作成",
                modalNewColumnName: "新しい列名",
                modalFormula: "計算式",
                modalAdd: "追加",
            },
            en: {
                appTitle: "CABI-KUN",
                navHome: "Home", navDashboard: "Summary", navCustom: "Custom Report", navDaily: "Daily View", navComparison: "Period Comparison", // NEW
                homeTitle: "Start Your Data Analysis", homeSubtitle: "Upload your CSV files and select or create a template to begin.",
                homeUploadTitle: "Upload CSV Files", homeSelectFiles: "Add Files", homeTemplateFolderTitle: "Manage Templates", 
                homeSelectFolder: "Load Template", homeActionTitle: "Actions", homeCreateTemplate: "Create New Template", homeStartAnalysis: "Start Analysis",
                homeManageFiles: "Manage Selected Files",
                csvPeekTitle: "Uploaded Files",
                filterDateRange: "Date Range", filterMedia: "Media", filterCampaign: "Campaign", filterAdGroup: "Ad Group",
                filterTargetCPA: "Target CPA",
                filterCampaignPlaceholder: "Search by partial match", filterAdGroupPlaceholder: "Search by partial match",
                filterApply: "Apply", filterReset: "Reset",
                // NEW: Added for Filter button and Modal
                headerFilterLabel: "Filter", 
                modalFilterTitle: "Filter Settings",
                headerTargetMeasureLabel: "Target:", 
                modalCreateTitle: "Create New Template", modalTemplateName: "Template Name", modalTemplateNamePlaceholder: "e.g., For Monthly Reporting",
                modalDimensions: "Dimensions", modalMeasures: "Measures",
                modalDateColumn: "Date Column (Required)",
                modalFormat: "Format",
                fileProcessInProgress: "Processing...",
                fileProcessSuccessSingle: "1 file processed successfully.",
                fileProcessSuccessPlural: "{count} files processed successfully.",
                fileProcessError: "Error processing files: {error}",
                allFilesRemoved: "All files removed.",
                noFilesSelected: "No files selected.",
                modalTemplateNameRequired: "Please enter a template name.",
                searchColumnsPlaceholder: "Search columns...",
                filterAllSelected: "All",
                filterItemsSelected: "{count} of {total} selected",
                cancel: "Cancel", save: "Save",
                summaryTrendAnalysis: "Trend Analysis",
                summaryPieCost: "Cost by {dimension}",
                summaryPieCV: "CV by {dimension}",
                summaryDetailsTitle: "Summary Details",
                tableTotal: "Total",
                groupBy: "Group by:",
                dailyTitle: "Daily Report",
                dailyDateHeader: "Date", 
                formatNumber: "Number",
                formatCurrency: "Currency",
                formatCurrencyJPY: "Yen (¥)",
                formatCurrencyUSD: "Dollar ($)",
                formatPercent: "Percentage (%)",
                formatDecimal: "Decimal",
                // Custom Report
                customReportCustomize: "Customize Columns",
                customReportModalTitle: "Customize Report Columns",
                customAvailableCols: "Available Columns",
                customSelectedCols: "Selected Columns",
                customApply: "Apply",
                customTableEmpty: "Please select at least one dimension or measure to display by clicking the 'Customize Columns' button.",
                // NEW: Custom Chart
                customChartTitle: "Custom Chart",
                customChartDimension: "Dimension:",
                customChartMeasure1: "Measure 1:",
                customChartMeasure2: "Measure 2:",
                customChartType: "Chart Type:",
                customChartTypeBar: "Bar",
                customChartTypeLine: "Line",
                customChartTypePie: "Pie",
                customChartNoMeasure: "Please select at least one measure.",
                customChartNoDimension: "Please select a dimension.",
                // NEW: Filter Conditions (for display, though logic uses English keys)
                filterContains: "contains",
                filterNotContains: "does not contain",
                filterExactMatch: "is equal to (case sensitive)",
                filterNotExactMatch: "is not equal to (case sensitive)",
                filterStartsWith: "starts with",
                filterEndsWith: "ends with",
                // NEW: File upload warning
                fileHeaderWarning: "All uploaded files must have the same header structure.",
                // NEW: Comparison Page
                headerMainPeriod: "Period 1",
                headerComparisonPeriod: "Comparison Period",
                comparisonTitle: "Period Comparison Report",
                comparisonViewPivot: "Pivot View",
                comparisonViewFlat: "Flat View",
                comparisonPeriod1: "Period 1",
                comparisonPeriod2: "Period 2",
                comparisonDifference: "Difference",
                comparisonDifferenceRate: "Ratio", // ADDED
                comparisonRatio: "Ratio",
                comparisonUsageNote: "<b>How to use:</b> Select the main period (Period 1) and the comparison period (Period 2), then click 'Customize Columns' to choose one dimension for grouping and the measures you want to compare.",
                modalAddNewFilter: "Add New Filter",
                modalCalculatedFieldTitle: "Create Calculated Field",
                modalNewColumnName: "New Column Name",
                modalFormula: "Formula",
                modalAdd: "Add",
            }
        };

        // DOM Elements
        const el = {
            loadingOverlay: document.getElementById('loading-overlay'),
            loadingText: document.getElementById('loading-text'),
            mainAppContainer: document.getElementById('main-app-container'),
            navMenu: document.getElementById('nav-menu'),
            appContent: document.getElementById('app-content'),
            homePage: document.getElementById('home-page'),
            dashboardWrapper: document.getElementById('dashboard-wrapper'),
            dashboardHeader: document.getElementById('dashboard-header'),
            csvFilesInput: document.getElementById('csv-files-input'),
            selectFilesBtn: document.getElementById('select-files-btn'),
            fileList: document.getElementById('file-list'),
            loadTemplatesBtn: document.getElementById('load-templates-btn'),
            templateFilesInput: document.getElementById('template-files-input'),
            templateList: document.getElementById('template-list'),
            createTemplateBtn: document.getElementById('create-template-btn'),
            startAnalysisBtn: document.getElementById('start-analysis-btn'),
            processingStatus: document.getElementById('processing-status'),
            manageFilesBtn: document.getElementById('manage-files-btn'),
            createTemplateModal: document.getElementById('create-template-modal'),
            templateNameInput: document.getElementById('template-name'),
            dimensionColumnsDropzone: document.getElementById('dimension-columns-dropzone'),
            measureColumnsDropzone: document.getElementById('measure-columns-dropzone'),
            saveTemplateBtn: document.getElementById('save-template-btn'),
            cancelCreateTemplateBtn: document.getElementById('cancel-create-template-btn'),
            templateSidePeek: document.getElementById('template-side-peek'),
            sidePeekTitle: document.getElementById('side-peek-title'),
            sidePeekContent: document.getElementById('side-peek-content'),
            closeSidePeekBtn: document.getElementById('close-side-peek-btn'),
            csvFilesSidePeek: document.getElementById('csv-files-side-peek'),
            csvPeekContent: document.getElementById('csv-peek-content'),
            closeCsvPeekBtn: document.getElementById('close-csv-peek-btn'),
            openFilterModalBtn: document.getElementById('open-filter-modal-btn'),
            filterModal: document.getElementById('filter-modal'),
            closeFilterModalBtn: document.getElementById('close-filter-modal-btn'),
            headerDateFilterInput: document.getElementById('header-date-filter-input'),
            dateRangeDisplay: document.getElementById('date-range-display'),
            dynamicFiltersContainer: document.getElementById('dynamic-filters-container'),
            applyFiltersBtn: document.getElementById('apply-filters-btn'),
            resetFiltersBtn: document.getElementById('reset-filters-btn'),
            languageToggle: document.getElementById('language-toggle'),
            currencyToggleBtn: document.getElementById('currency-toggle-btn'),
            addCalculatedFieldBtn: document.getElementById('add-calculated-field-btn'),
            calculatedFieldModal: document.getElementById('calculated-field-modal'),
            cancelCalculatedFieldBtn: document.getElementById('cancel-calculated-field-btn'),
            saveCalculatedFieldBtn: document.getElementById('save-calculated-field-btn'),
            // Custom Report Table
            customReportModal: document.getElementById('custom-report-modal'),
            availableColumnsListCustom: document.getElementById('available-columns-list-custom'),
            selectedColumnsDropzoneCustom: document.getElementById('selected-columns-dropzone-custom'),
            applyCustomReportBtn: document.getElementById('apply-custom-report-btn'),
            cancelCustomReportBtn: document.getElementById('cancel-custom-report-btn'),
            // NEW: Header Target Elements
            targetMeasureSelect: document.getElementById('target-measure-select'),
            targetValueInput: document.getElementById('target-value-input'),
            // NEW: Filter Count Badge
            filterCountBadge: document.getElementById('filter-count-badge'),
            // NEW: File Header Warning
            fileHeaderWarningEl: document.getElementById('file-header-warning'),
            
            // --- NEW Comparison Elements ---
            comparisonDateFilterContainer: document.getElementById('comparison-date-filter-container'),
            comparisonDateFilterInput: document.getElementById('comparison-date-filter-input'),
            comparisonDateRangeDisplay: document.getElementById('comparison-date-range-display'),
            comparisonPage: document.getElementById('comparison-page'),
            toggleComparisonViewBtn: document.getElementById('toggle-comparison-view-btn'),
            comparisonReportTableContainer: document.getElementById('comparison-report-table-container'),
            
            // --- NEW Comparison Elements ---
            comparisonDateFilterInput: document.getElementById('comparison-date-filter-input'),
            comparisonDateRangeDisplay: document.getElementById('comparison-date-range-display'),
            comparisonPage: document.getElementById('comparison-page'),
            toggleComparisonViewBtn: document.getElementById('toggle-comparison-view-btn'),
            comparisonReportTableContainer: document.getElementById('comparison-report-table-container'),
            
            // NEW Comparison Customization Modal Elements
            comparisonCustomizeModal: document.getElementById('comparison-customize-modal'),
            availableColumnsListComparison: document.getElementById('available-columns-list-comparison'),
            selectedColumnsDropzoneComparison: document.getElementById('selected-columns-dropzone-comparison'),
            applyComparisonCustomizeBtn: document.getElementById('apply-comparison-customize-btn'),
            cancelComparisonCustomizeBtn: document.getElementById('cancel-comparison-customize-btn'),
        };
        
        // --- NEW: Helper function to translate elements within a given scope ---
        function translateElements(scope = document) {
            const texts = uiTexts[currentLanguage];
            scope.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.dataset.i18n;
                if (texts[key]) {
                    if (element.tagName === 'OPTION') {
                        element.textContent = texts[key];
                    } else {
                        element.textContent = texts[key];
                    }
                }
            });
            scope.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
                 const key = element.dataset.i18nPlaceholder;
                if (texts[key]) {
                    element.placeholder = texts[key];
                }
            });
            scope.querySelectorAll('[data-i18n-html]').forEach(element => {
                const key = element.dataset.i18nHtml;
                if (texts[key]) {
                    element.innerHTML = texts[key];
                }
            });
            
            // NEW: Translate Filter Condition Select options
            const conditionSelect = scope.querySelector('#filter-condition-select');
            if (conditionSelect) {
                conditionSelect.querySelector('option[value="contains"]').textContent = texts.filterContains || 'contains';
                conditionSelect.querySelector('option[value="not_contains"]').textContent = texts.filterNotContains || 'does not contain';
                conditionSelect.querySelector('option[value="exact_match"]').textContent = texts.filterExactMatch || 'is equal to (case sensitive)';
                conditionSelect.querySelector('option[value="not_exact_match"]').textContent = texts.filterNotExactMatch || 'is not equal to (case sensitive)';
                conditionSelect.querySelector('option[value="starts_with"]').textContent = texts.filterStartsWith || 'starts with';
                conditionSelect.querySelector('option[value="ends_with"]').textContent = texts.filterEndsWith || 'ends with';
            }

            // NEW: Update Comparison Button Text
            if (el.toggleComparisonViewBtn) {
                 const span = el.toggleComparisonViewBtn.querySelector('span');
                 if (span) {
                     span.textContent = comparisonState.isPivotView ? texts.comparisonViewPivot : texts.comparisonViewFlat;
                 }
            }

            // NEW: Update comparison usage note with HTML content
            const usageNoteContainer = scope.querySelector('#comparison-usage-note-container');
            if (usageNoteContainer && texts.comparisonUsageNote) {
                usageNoteContainer.innerHTML = texts.comparisonUsageNote;
            }
        }


        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            el.loadingOverlay.style.display = 'none';
            el.mainAppContainer.style.display = 'flex';
            initEventListeners();
            updateUIForLanguage();
            showPage('home-page');
            updateHomeButtonStates();
        });


        // --- LANGUAGE & UI ---
        function updateUIForLanguage() {
            const texts = uiTexts[currentLanguage];
            
            // Apply translation to static/already existing UI elements (scope = document)
            translateElements(); 

            // Specific translation logic for non-data-i18n elements
             const modalTitleEl = document.getElementById('filter-modal').querySelector('h3[data-i18n="modalFilterTitle"]');
             if (modalTitleEl) {
                 modalTitleEl.textContent = texts.modalFilterTitle;
             }
             
             // NEW: Set File Header Warning text
             if (el.fileHeaderWarningEl) {
                 el.fileHeaderWarningEl.textContent = texts.fileHeaderWarning;
                 // Show warning text permanently
                 el.fileHeaderWarningEl.classList.remove('hidden');
             }

             // Re-render active dimension filter list to update labels
             if (activeDimensionFilters.length > 0) {
                 renderActiveDimensionFilters();
             }
             
             // Re-render dashboard page to apply translation to dynamic data/tables
             const activePage = document.querySelector('.app-page:not(.hidden)');
             if (activePage && activePage.id !== 'home-page') {
                 renderDashboardPage(activePage.id); 
             }
        }

        // --- UI STATE MANAGEMENT ---
        function updateHomeButtonStates() {
            const canCreateTemplate = csvHeaders.length > 0;
            el.createTemplateBtn.disabled = !canCreateTemplate;
           
            const canStartAnalysis = allData.length > 0 && templateConfig;
            el.startAnalysisBtn.disabled = !canStartAnalysis;
        }

        // --- NAVIGATION ---
        function showPage(pageId) {
            document.querySelectorAll('.app-page').forEach(page => page.classList.add('hidden'));
            document.getElementById(pageId).classList.remove('hidden');

            // Update active link styling
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('nav-link-active', 'text-white', 'shadow-md');
                link.classList.add('text-slate-700', 'hover:bg-slate-100'); // Ensure reset to default
            });
            
            const activeLink = document.querySelector(`.nav-link[data-page="${pageId}"]`);
            if (activeLink) {
                activeLink.classList.add('nav-link-active', 'text-white', 'shadow-md');
                activeLink.classList.remove('text-slate-700', 'hover:bg-slate-700', 'hover:bg-slate-100');
            }
            
            // Toggle Comparison Period filter visibility/state
            const isComparisonPage = pageId === 'comparison-page';
            if (isComparisonPage) {
                el.comparisonDateFilterContainer.classList.remove('date-filter-disabled');
                el.comparisonDateFilterInput.disabled = false;
                el.comparisonDateFilterContainer.querySelector('svg').classList.remove('text-slate-500');
                el.comparisonDateRangeDisplay.classList.remove('text-slate-600');
            } else {
                 el.comparisonDateFilterContainer.classList.add('date-filter-disabled');
                 el.comparisonDateFilterInput.disabled = true;
                 el.comparisonDateFilterContainer.querySelector('svg').classList.add('text-slate-500');
                 el.comparisonDateRangeDisplay.classList.add('text-slate-600');
            }


            if (pageId === 'home-page') {
                el.dashboardWrapper.classList.add('hidden');
                el.homePage.classList.remove('hidden');
                el.dashboardHeader.classList.add('hidden');
                document.querySelectorAll('.dashboard-nav-link').forEach(link => {
                    link.classList.add('opacity-50', 'pointer-events-none');
                });
            } else {
                el.homePage.classList.add('hidden');
                el.dashboardWrapper.classList.remove('hidden');
                el.dashboardHeader.classList.remove('hidden');
                renderDashboardPage(pageId);
            }
        }
        
        // --- HOME PAGE LOGIC ---
        function handleFileSelection(event) {
            const files = event.target.files;
            if (!files.length) return;

            const newFiles = Array.from(files);
            
            // Combine existing and new files. Use a Map to ensure the latest upload
            // overwrites older files with the same name.
            const fileMap = new Map();
            // Add existing files
            uploadedFileObjects.forEach(file => fileMap.set(file.name, file));
            // Add new files (overwrites if names match)
            newFiles.forEach(file => fileMap.set(file.name, file));
            
            uploadedFileObjects = Array.from(fileMap.values());

            // Clear input value so the 'change' event fires if the same file is selected again
            event.target.value = '';

            renderFileLists();
            
            el.manageFilesBtn.classList.remove('hidden');
            el.processingStatus.textContent = '';
            csvHeaders = []; // Force header recalculation
            
            if (uploadedFileObjects.length > 0) {
                processFiles();
            }
            updateHomeButtonStates();
        }

        function renderFileLists() {
            const texts = uiTexts[currentLanguage];
            if (uploadedFileObjects.length === 0) {
                el.fileList.innerHTML = `<p class="text-slate-500 text-center">${texts.noFilesSelected}</p>`;
                el.csvPeekContent.innerHTML = '';
                el.manageFilesBtn.classList.add('hidden');
                return;
            }
            
            let fileListHTML = '';
            let peekContentHTML = '';

            uploadedFileObjects.forEach(file => {
                const fileSize = (file.size / 1024).toFixed(2);
                const commonFileHtml = `<span>${file.name}</span><span class="text-slate-500">${fileSize} KB</span>`;
                
                fileListHTML += `<div class="p-2 bg-slate-50 rounded-md flex justify-between items-center">${commonFileHtml}</div>`;

                peekContentHTML += `
                    <div class="p-2 border-b flex justify-between items-center gap-2">
                        <div class="flex flex-col text-sm min-w-0">
                            <span class="font-medium truncate" title="${file.name}">${file.name}</span>
                            <span class="text-slate-500">${fileSize} KB</span>
                        </div>
                        <button class="remove-file-btn p-1 rounded-full text-red-500 hover:bg-red-100 flex-shrink-0" data-filename="${file.name}">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                        </button>
                    </div>
                `;
            });
            
            el.fileList.innerHTML = fileListHTML;
            el.csvPeekContent.innerHTML = peekContentHTML;

            el.csvPeekContent.querySelectorAll('.remove-file-btn').forEach(btn => {
                btn.addEventListener('click', handleRemoveFile);
            });
        }
        
        function handleRemoveFile(event) {
            const fileName = event.currentTarget.dataset.filename;
            uploadedFileObjects = uploadedFileObjects.filter(f => f.name !== fileName);
            renderFileLists();
            
            if (uploadedFileObjects.length > 0) {
                csvHeaders = []; // Force header recalculation
                processFiles();
            } else {
                allData = [];
                csvHeaders = [];
                el.processingStatus.textContent = uiTexts[currentLanguage].allFilesRemoved;
                updateHomeButtonStates();
            }
        }

        // --- CSV Processing (Main Thread) ---
        
        function loadScript(src, globalVar) {
            return new Promise((resolve, reject) => {
                if (window[globalVar]) {
                    return resolve();
                }
                const script = document.createElement('script');
                script.src = src;
                script.onload = () => resolve();
                script.onerror = () => reject(new Error(`Script load error for ${src}`));
                document.head.appendChild(script);
            });
        }
        
        async function processFiles() {
            if (uploadedFileObjects.length === 0) {
                return;
            }
            el.processingStatus.innerHTML = `<div class="flex items-center justify-center gap-2"><div class="loader" style="width:20px;height:20px;border-width:2px;"></div><span>${uiTexts[currentLanguage].fileProcessInProgress}</span></div>`;
            updateHomeButtonStates();

            try {
                await Promise.all([
                    loadScript('https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js', 'Papa'),
                    loadScript('https://cdnjs.cloudflare.com/ajax/libs/jschardet/2.3.0/jschardet.min.js', 'jschardet')
                ]);

                const readAndDetectEncoding = (file) => {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve(new Uint8Array(e.target.result));
                        reader.onerror = (e) => reject(e);
                        reader.readAsArrayBuffer(file);
                    }).then(uint8array => {
                        const detected = jschardet.detect(uint8array);
                        if (detected.encoding.toUpperCase() === 'WINDOWS-1252' && detected.confidence < 0.9) {
                            return 'Shift_JIS';
                        }
                        return (detected && detected.encoding) ? detected.encoding : 'UTF-8';
                    });
                };
                
                const allParsedData = await Promise.all(
                    uploadedFileObjects.map(async (file) => {
                        const encoding = await readAndDetectEncoding(file);
                        return new Promise((resolve, reject) => {
                            Papa.parse(file, {
                                encoding: encoding,
                                header: true,
                                skipEmptyLines: true,
                                dynamicTyping: true,
                                complete: (results) => {
                                    if (results.errors.length > 0) {
                                       console.warn(`Parsing errors in ${file.name}:`, results.errors);
                                    }
                                    if (results.meta.fields && results.meta.fields.length > 0) {
                                        const firstHeader = results.meta.fields[0];
                                        if (firstHeader.charCodeAt(0) === 0xFEFF) {
                                            results.meta.fields[0] = firstHeader.substring(1);
                                        }
                                        results.data.forEach(row => {
                                            const firstKey = Object.keys(row)[0]; // Check if firstKey exists before checking charCodeAt
                                            if (firstKey && firstKey.charCodeAt(0) === 0xFEFF) { // Check if firstKey exists before checking charCodeAt
                                                const cleanKey = firstKey.substring(1);
                                                row[cleanKey] = row[firstKey];
                                                delete row[firstKey];
                                            }
                                        });
                                    }
                                    resolve(results);
                                },
                                error: (error) => reject(new Error(`PapaParse error on ${file.name}: ${error.message}`)),
                            });
                        });
                    })
                );

                let combinedData = [];
                let firstHeaders = [];

                allParsedData.forEach(result => {
                    combinedData = combinedData.concat(result.data);
                    if (firstHeaders.length === 0 && result.meta.fields) {
                        firstHeaders = result.meta.fields;
                    }
                });

                allData = combinedData;
                csvHeaders = firstHeaders.filter(h => h); // Filter out empty headers
                const fileCount = uploadedFileObjects.length;
                const successMsg = (fileCount === 1) 
                    ? uiTexts[currentLanguage].fileProcessSuccessSingle
                    : uiTexts[currentLanguage].fileProcessSuccessPlural.replace('{count}', fileCount);
                el.processingStatus.textContent = successMsg;
            
            } catch (error) {
                console.error("Error processing files on main thread:", error);
                el.processingStatus.textContent = uiTexts[currentLanguage].fileProcessError.replace('{error}', error.message);
                allData = [];
                csvHeaders = [];
            } finally {
                updateHomeButtonStates();
            }
        }

        function handleTemplateFileSelection(event) {
            const file = event.target.files[0];
            if (!file) {
                loadedTemplates = [];
                templateConfig = null;
                renderTemplates([]);
                updateHomeButtonStates();
                return;
            };

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const templateData = JSON.parse(e.target.result);
                    templateData.fileName = file.name;
                    loadedTemplates = [templateData];
                    templateConfig = templateData;
                    console.log("Template auto-selected:", templateConfig);
                    renderTemplates(loadedTemplates);
                    updateHomeButtonStates();
                } catch (err) {
                    console.error(`Error parsing template file ${file.name}:`, err);
                    alert(`Could not parse ${file.name}. Is it a valid JSON template file?`);
                    loadedTemplates = [];
                    templateConfig = null;
                    renderTemplates([]);
                    updateHomeButtonStates();
                }
            };
            reader.onerror = () => {
                console.error(`Error reading file ${file.name}`);
                alert(`Could not read file ${file.name}.`);
                loadedTemplates = [];
                templateConfig = null;
                renderTemplates([]);
                updateHomeButtonStates();
            };
            reader.readAsText(file);
        }

        function renderTemplates(templates) {
            if (templates.length === 0) {
                el.templateList.innerHTML = `<p class="text-slate-500">No templates loaded.</p>`;
                return;
            }
            
            let templatesHTML = '';
            templates.forEach(t => {
                const isSelected = templateConfig && t.fileName === templateConfig.fileName;
                const selectedClasses = isSelected ? 'ring-2 ring-green-500 bg-green-50' : ''; // Updated color
                templatesHTML += `
                    <div class="template-item p-3 bg-white border rounded-lg flex justify-between items-center cursor-pointer hover:bg-slate-50 ${selectedClasses}" data-template-name="${t.fileName}">
                        <span class="font-semibold">${t.templateName}</span>
                        <div class="flex items-center gap-2">
                             <button class="view-template-btn text-sm text-green-600 hover:underline" data-template-name="${t.fileName}">View</button> <div class="w-1 h-1 bg-slate-300 rounded-full"></div>
                             <span class="text-sm text-slate-500">${t.fileName}</span>
                        </div>
                    </div>`;
            });
            el.templateList.innerHTML = templatesHTML;
        }

        function showTemplateDetails(templateData) {
            el.sidePeekTitle.textContent = templateData.templateName;
            let contentHTML = `
                <div>
                    <h4 class="font-bold text-md mb-2 text-green-700">Date Column</h4>
                    <p class="text-sm bg-green-50 p-2 rounded-lg">${templateData.dateColumn}</p>
                </div>
                <div>
                    <h4 class="font-bold text-md mb-2 text-green-700">Dimensions</h4>
                    <ul class="list-disc list-inside space-y-1 text-sm">
                        ${templateData.dimensions.map(d => `<li>${d}</li>`).join('')}
                    </ul>
                </div>
                <div>
                    <h4 class="font-bold text-md mb-2 text-green-700">Measures</h4>
                    <ul class="list-disc list-inside space-y-1 text-sm">
                        ${(templateData.measures || []).map(m => {
                            if (typeof m === 'string') {
                                return `<li>${m}</li>`;
                            } else if (typeof m === 'object') {
                                const formatText = m.format ? ` <span class="text-xs text-slate-400">[${m.format}]</span>` : '';
                                if (m.operand1) {
                                    return `<li><b>${m.name}</b>${formatText} <span class="text-xs text-slate-500">(${m.operand1} ${m.operator} ${m.operand2})</span></li>`;
                                } else {
                                     return `<li>${m.name}${formatText}</li>`;
                                }
                            }
                            return '';
                        }).join('')}
                    </ul>
                </div>
            `;
            el.sidePeekContent.innerHTML = contentHTML;
            el.templateSidePeek.classList.add('open');
        }

        function openCreateTemplateModal() {
            if (csvHeaders.length === 0) {
                alert(currentLanguage === 'ja' ? '先にCSVファイルをアップロードして処理してください。' : 'Please upload and process a CSV file first.');
                return;
            }
            updateUIForLanguage();
            tempCalculatedFields = [];

            const availableColumnsList = document.getElementById('available-columns-list');
            el.dimensionColumnsDropzone.innerHTML = '';
            el.measureColumnsDropzone.innerHTML = '';
            
            const dateColumnSelect = document.getElementById('template-date-column');
            dateColumnSelect.innerHTML = '';
            
            let availableColumnsHTML = '';
            csvHeaders.filter(h => h).forEach(header => { // Ensure header is not empty
                availableColumnsHTML += `<div class="draggable-item" data-column-id="${header}">${header}</div>`;
                const option = document.createElement('option');
                option.value = header;
                option.textContent = header;
                if (['date', '日付', 'report_date'].includes(header.toLowerCase())) {
                    option.selected = true;
                }
                dateColumnSelect.appendChild(option);
            });
            availableColumnsList.innerHTML = availableColumnsHTML;
            
            const searchInput = document.getElementById('column-search-input');
            searchInput.value = '';
            
            let searchTimeout;
            searchInput.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    const searchTerm = searchInput.value.toLowerCase();
                    const allColumns = availableColumnsList.querySelectorAll('.draggable-item');
                    allColumns.forEach(item => {
                        const columnName = item.textContent.toLowerCase();
                        if (columnName.includes(searchTerm)) {
                            item.style.display = 'flex';
                        } else {
                            item.style.display = 'none';
                        }
                    });
                }, 200);
            });

            new Sortable(availableColumnsList, {
                group: 'shared-columns',
                animation: 150,
                ghostClass: 'sortable-ghost',
                onAdd: function (evt) {
                    // When an item is moved back to the available list from the measures list,
                    // remove the format selector that was added.
                    const itemEl = evt.item;
                    const formatSelector = itemEl.querySelector('.measure-format-select');
                    if (formatSelector) {
                        itemEl.removeChild(formatSelector);
                    }
                }
            });
            new Sortable(el.dimensionColumnsDropzone, {
                group: 'shared-columns',
                animation: 150,
                ghostClass: 'sortable-ghost',
                onAdd: function (evt) {
                    // When an item is moved from the measures list to the dimensions list,
                    // remove the format selector that was added.
                    const itemEl = evt.item;
                    const formatSelector = itemEl.querySelector('.measure-format-select');
                    if (formatSelector) {
                        itemEl.removeChild(formatSelector);
                    }
                }
            });
            new Sortable(el.measureColumnsDropzone, {
                group: 'shared-columns',
                animation: 150,
                ghostClass: 'sortable-ghost',
                onAdd: function (evt) {
                    const itemEl = evt.item;
                    // Prevent adding format selector to calculated fields again
                    if (itemEl.dataset.isCalc === 'true' && itemEl.querySelector('.measure-format-select')) {
                        return;
                    }
                    
                    const formatSelector = document.createElement('select');
                    formatSelector.className = 'measure-format-select text-xs rounded border-slate-200 ml-auto p-1';
                    formatSelector.innerHTML = `
                        <option value="number">${uiTexts[currentLanguage].formatNumber}</option>
                        <option value="currency">${uiTexts[currentLanguage].formatCurrency}</option>
                        <option value="percent">${uiTexts[currentLanguage].formatPercent}</option>
                        <option value="decimal">${uiTexts[currentLanguage].formatDecimal}</option>
                    `;
                    
                    const columnName = itemEl.dataset.columnId.toLowerCase();
                    if (columnName.includes('cost') || columnName.includes('費用')) {
                        formatSelector.value = 'currency';
                    }
                    
                    itemEl.appendChild(formatSelector);
                }
            });

            el.createTemplateModal.classList.remove('hidden');
            el.createTemplateModal.classList.add('flex');
        }


        function closeCreateTemplateModal() {
            el.createTemplateModal.classList.add('hidden');
            el.createTemplateModal.classList.remove('flex');
            el.templateNameInput.value = '';
            document.getElementById('template-name-error').classList.add('hidden');
            el.templateNameInput.classList.remove('border-red-500', 'focus:ring-red-500', 'focus:border-red-500'); // Updated color
            el.templateNameInput.classList.add('focus:ring-green-500', 'focus:border-green-500'); // Updated color
        }

        function openCalculatedFieldModal() {
            const measures = Array.from(el.measureColumnsDropzone.children)
                 .map(el => el.dataset.columnId)
                 .filter(id => id); // Filter out any empty IDs
            const operand1Select = document.getElementById('calc-operand1'); // Filter out any empty IDs
            const operand2Select = document.getElementById('calc-operand2');
            operand1Select.innerHTML = '';
            operand2Select.innerHTML = '';

            if (measures.length < 1) {
                alert(currentLanguage === 'ja' ? 'メジャーボックスに少なくとも1つの列をドラッグしてください。' : 'Please drag at least one column to the Measures box.');
                return;
            }

            measures.forEach(m => {
                operand1Select.innerHTML += `<option value="${m}">${m}</option>`;
                operand2Select.innerHTML += `<option value="${m}">${m}</option>`;
            });
            
            document.getElementById('calculated-field-name').value = '';
            translateElements(el.calculatedFieldModal);
            el.calculatedFieldModal.classList.remove('hidden');
            el.calculatedFieldModal.classList.add('flex');
        }

        function closeCalculatedFieldModal() {
            el.calculatedFieldModal.classList.add('hidden');
            el.calculatedFieldModal.classList.remove('flex');
        }
        
        function saveCalculatedField() {
            const name = document.getElementById('calculated-field-name').value.trim();
            const operand1 = document.getElementById('calc-operand1').value;
            const operator = document.getElementById('calc-operator').value;
            const operand2 = document.getElementById('calc-operand2').value;
            const format = document.getElementById('calculated-field-format').value;

            if (!name || !operand1 || !operator || !operand2) {
                alert(currentLanguage === 'ja' ? 'すべてのフィールドを入力してください。' : 'Please fill in all fields.');
                return;
            }
            
            const newField = { name, operand1, operator, operand2, format };
            tempCalculatedFields.push(newField);
            
            const itemEl = document.createElement('div');
            itemEl.className = 'draggable-item bg-cyan-50 border-cyan-200';
            itemEl.dataset.columnId = name;
            itemEl.dataset.isCalc = 'true';

            const nameSpan = document.createElement('span');
            nameSpan.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 inline-block mr-2 text-cyan-600"><path d="M8.5 2h7L21 12.5V22H3V12.5L8.5 2z"></path><path d="M12 13V2"></path></svg>${name}`;
            itemEl.appendChild(nameSpan);

            const formatSelector = document.createElement('select');
            formatSelector.className = 'measure-format-select text-xs rounded border-slate-200 ml-auto p-1';
            formatSelector.innerHTML = `
                <option value="number">${uiTexts[currentLanguage].formatNumber}</option>
                <option value="currency">${uiTexts[currentLanguage].formatCurrency}</option>
                <option value="percent">${uiTexts[currentLanguage].formatPercent}</option>
                <option value="decimal">${uiTexts[currentLanguage].formatDecimal}</option>
            `;
            formatSelector.value = format;
            itemEl.appendChild(formatSelector);

            el.measureColumnsDropzone.appendChild(itemEl);
            closeCalculatedFieldModal();
        }

        async function saveTemplate() {
            const templateName = el.templateNameInput.value.trim();
            const templateNameError = document.getElementById('template-name-error');
            const texts = uiTexts[currentLanguage];
            
            el.templateNameInput.classList.remove('border-red-500', 'focus:ring-red-500', 'focus:border-red-500');
            el.templateNameInput.classList.add('focus:ring-green-500', 'focus:border-green-500');
            templateNameError.classList.add('hidden');

            if (!templateName) {
                templateNameError.textContent = texts.modalTemplateNameRequired;
                templateNameError.classList.remove('hidden');
                el.templateNameInput.classList.add('border-red-500', 'focus:ring-red-500', 'focus:border-red-500');
                el.templateNameInput.classList.remove('focus:ring-green-500', 'focus:border-green-500');
                return;
            }

            const dateColumn = document.getElementById('template-date-column').value;
            if (!dateColumn) {
                alert(texts.modalDateColumn + " " + (currentLanguage === 'ja' ? 'を選択してください。' : 'must be selected.'));
                return;
            }

            const dimensions = Array.from(el.dimensionColumnsDropzone.children).map(el => el.dataset.columnId).filter(id => id);
            
            const measures = Array.from(el.measureColumnsDropzone.children).map(item => {
                const name = item.dataset.columnId;
                const formatSelect = item.querySelector('.measure-format-select');
                const format = formatSelect ? formatSelect.value : 'number';

                if (item.dataset.isCalc === 'true') {
                    const calcField = tempCalculatedFields.find(f => f.name === name);
                    if (calcField) {
                         return { ...calcField, format };
                    }
                }
                return { name, format };
            }).filter(m => m.name); // Filter out entries with empty names


            if (dimensions.length === 0 || measures.length === 0) {
                alert(currentLanguage === 'ja' ? "ディメンションとメジャーを少なくとも1つずつ選択してください。" : "Please select at least one dimension and one measure.");
                return;
            }
            
            const templateData = {
                templateName,
                dateColumn,
                dimensions,
                measures,
            };
            
            const fileName = `${templateName.replace(/\s+/g, '_')}.json`;
            const blob = new Blob([JSON.stringify(templateData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert(`Template "${templateName}" is being downloaded.`);
            closeCreateTemplateModal();
        }
        
        function startAnalysis() {
            if (!templateConfig) {
                alert("Please select a template first.");
                return;
            }
            
            // Ensure all measures have a format object for backward compatibility
            if (templateConfig.measures && templateConfig.measures.some(m => typeof m === 'string' || !m.format)) {
                templateConfig.measures = templateConfig.measures.map(m => {
                    if (typeof m === 'string') {
                        // Default to 'number' format if not specified
                        return { name: m, format: 'number' };
                    } else if (typeof m === 'object' && !m.format) {
                        return { ...m, format: 'number' };
                    }
                    return m;
                });
            }

            console.log("Starting analysis with", templateConfig.templateName);
            normalizeData();
            setupGlobalFilters(); // Setup filters UI

            // Initialize custom report config with the first dimension from the template.
            const initialDimensions = [templateConfig.dimensions[0]].filter(Boolean); 
            
            // Ensure initialDimensions is unique and exists in the data.
            customReportConfig.dimensions = [...new Set(initialDimensions)].filter(dim => allData[0] && allData[0][dim] !== undefined);
            customReportConfig.measures = templateConfig.measures.map(m => m.name); // Default to all measures
            
            // --- Initialize comparison state & report config ---
            // Default to the first dimension from the template, or 'date' as a fallback.
            const initialComparisonDim = templateConfig.dimensions.length > 0 ? templateConfig.dimensions[0] : 'date'; // Default to first dimension
            
            comparisonReportConfig.dimensions = [initialComparisonDim].filter(dim => dim); // Ensure it's not an empty array
            comparisonReportConfig.measures = templateConfig.measures.map(m => m.name); // Default to all measures

            // Set initial grouping state
            comparisonState.groupByDimension = comparisonReportConfig.dimensions[0] || 'date';
            comparisonState.isPivotView = true;

            // --- NEW: Setup Target Select ---
            setupTargetSelect();

            document.querySelectorAll('.dashboard-nav-link').forEach(link => {
                link.classList.remove('opacity-50', 'pointer-events-none');
            });

            showPage('dashboard-page');
            applyGlobalFilters(); // Apply filters initially
        }

        function normalizeData() {
            const dateCol = templateConfig.dateColumn;
             if (!allData[0] || allData[0][dateCol] === undefined) {
                console.error("Date column specified in template not found in data rows.");
                alert(`Error: Date column "${dateCol}" not found in data. Please check your template and CSV file.`);
                showPage('home-page');
                return;
            }

            const processed = allData.map(row => {
                const newRow = {};
                for (const key in row) {
                    newRow[key] = row[key];
                }
                
                const dateValue = row[dateCol];
                if (dateValue) {
                    const dateObj = new Date(dateValue);
                    if (!isNaN(dateObj.getTime())) {
                        const year = dateObj.getFullYear(); // Standardized date field
                        const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                        const day = String(dateObj.getDate()).padStart(2, '0');
                        newRow.date = `${year}-${month}-${day}`; // Standardized date field
                    } else {
                        newRow.date = null;
                    }
                } else {
                    newRow.date = null;
                }

                // Ensure base measures are numbers
                templateConfig.measures.forEach(measure => {
                    if (typeof measure === 'object' && measure.operand1) { // Calculated field, skip for now, will calculate later
                        // Calculated field, skip for now, will calculate later in grouping/table logic
                         if (row[measure.operand1] !== undefined) newRow[measure.operand1] = parseFloat(row[measure.operand1]) || 0;
                         if (row[measure.operand2] !== undefined) newRow[measure.operand2] = parseFloat(row[measure.operand2]) || 0;
                    } else if (typeof measure === 'object') {
                        newRow[measure.name] = parseFloat(row[measure.name]) || 0;
                    } else if (typeof measure === 'string') {
                         newRow[measure] = parseFloat(row[measure]) || 0;
                    }
                });
                return newRow;
            }).filter(row => row.date);

            allData = processed;
            console.log("Data normalized:", allData.slice(0, 2));
        }

        // --- Filter Setup and Management ---
        
        function setupGlobalFilters() {
            const dateColumn = templateConfig.dateColumn;
            const dates = allData.map(d => new Date(d.date)).filter(d => !isNaN(d));
            
            let defaultDateRange = [];
            let defaultComparisonRange = null; // NEW
            
            // --- Period 1 (Global) Flatpickr Setup ---
            if(headerFlatpickr) headerFlatpickr.destroy();
            headerFlatpickr = flatpickr(el.headerDateFilterInput, {
                mode: "range",
                dateFormat: "Y-m-d",
                defaultDate: defaultDateRange,
                onClose: function(selectedDates, dateStr, instance) {
                    el.dateRangeDisplay.textContent = dateStr || uiTexts[currentLanguage].filterDateRange;
                    applyGlobalFilters();
                }
            });
            // Set initial default date after creation
            if (dates.length > 0) {
                const maxDate = new Date(Math.max.apply(null, dates));
                const startMonth = maxDate.getMonth();
                const startYear = maxDate.getFullYear();
                const firstDayOfMonth = new Date(startYear, startMonth, 1);
                defaultDateRange = [firstDayOfMonth, maxDate];
                headerFlatpickr.setDate(defaultDateRange, false); // Set without triggering event
            }

            // --- Period 2 (Comparison) Flatpickr Setup ---
            if(comparisonFlatpickr) comparisonFlatpickr.destroy();
            comparisonFlatpickr = flatpickr(el.comparisonDateFilterInput, {
                mode: "range",
                dateFormat: "Y-m-d",
                onClose: function(selectedDates, dateStr, instance) {
                    comparisonState.period2Range = selectedDates.length === 2 ? selectedDates : null;
                    el.comparisonDateRangeDisplay.textContent = dateStr || uiTexts[currentLanguage].headerComparisonPeriod;
                    
                    const currentPage = document.querySelector('.app-page:not(.hidden)');
                    if (currentPage && currentPage.id === 'comparison-page') {
                        renderDashboardPage('comparison-page');
                    }
                }
            });

            // Ensure initial display reflects the default date range
             if (headerFlatpickr.selectedDates.length === 2) {
                 el.dateRangeDisplay.textContent = headerFlatpickr.formatDate(headerFlatpickr.selectedDates[0], "Y-m-d") + ' ~ ' + headerFlatpickr.formatDate(headerFlatpickr.selectedDates[1], "Y-m-d");
            } else {
                 el.dateRangeDisplay.textContent = uiTexts[currentLanguage].filterDateRange;
            }
            
            // --- Dynamic Filters Setup ---
            const dimensionSelect = document.getElementById('filter-dimension-select');
            dimensionSelect.innerHTML = '<option value="" disabled selected>Select Dimension</option>';
            translateElements(dimensionSelect.closest('div')); // Translate select options

            const activeFiltersList = document.getElementById('active-filters-list'); // Translate select options
            activeFiltersList.innerHTML = '';
            
            // Populate dimension selector in the modal
            templateConfig.dimensions.filter(d => d).forEach(dimension => {
                 dimensionSelect.innerHTML += `<option value="${dimension}">${dimension}</option>`;
            });

            // Update Add Filter button state
            const addFilterBtn = document.getElementById('add-new-filter-btn');
            const valueInput = document.getElementById('filter-value-input');
            
            const checkAddButtonState = () => {
                const dimSelected = dimensionSelect.value !== '';
                const valueEntered = valueInput.value.trim() !== '';
                addFilterBtn.disabled = !(dimSelected && valueEntered);
            };

            dimensionSelect.addEventListener('change', checkAddButtonState);
            valueInput.addEventListener('input', checkAddButtonState);
            
            renderActiveDimensionFilters();
        }
        
        // Closes the comparison report customization modal.
        function closeComparisonCustomizeModal() {
            el.comparisonCustomizeModal.classList.add('hidden');
            el.comparisonCustomizeModal.classList.remove('flex');
        }

        // --- Filter Helper Functions ---
        
        function getConditionLabel(condition) {
             const labels = {
                'contains': uiTexts[currentLanguage].filterContains,
                'not_contains': uiTexts[currentLanguage].filterNotContains,
                'exact_match': uiTexts[currentLanguage].filterExactMatch,
                'not_exact_match': uiTexts[currentLanguage].filterNotExactMatch,
                'starts_with': uiTexts[currentLanguage].filterStartsWith,
                'ends_with': uiTexts[currentLanguage].filterEndsWith
            };
            return labels[condition] || condition; 
        }

        function addDimensionFilter() {
            const dimensionSelect = document.getElementById('filter-dimension-select');
            const conditionSelect = document.getElementById('filter-condition-select');
            const valueInput = document.getElementById('filter-value-input');

            const dimension = dimensionSelect.value;
            const condition = conditionSelect.value;
            // Split by newline, trim, and remove empty lines.
            const values = valueInput.value.split('\n').map(v => v.trim()).filter(v => v !== ''); 

            if (!dimension || values.length === 0) return;

            activeDimensionFilters.push({
                id: nextFilterId++,
                dimension,
                condition,
                values
            });

            // Reset inputs
            dimensionSelect.value = '';
            conditionSelect.value = 'contains';
            valueInput.value = '';
            document.getElementById('add-new-filter-btn').disabled = true;
            
            renderActiveDimensionFilters();
        }
        
        function removeDimensionFilter(filterId) {
            activeDimensionFilters = activeDimensionFilters.filter(f => f.id !== filterId);
            renderActiveDimensionFilters();
        }
        

        function renderActiveDimensionFilters() {
            const activeFiltersList = document.getElementById('active-filters-list');
            activeFiltersList.innerHTML = '';
            
            activeDimensionFilters.forEach(f => {
                const valuesDisplay = f.values.length > 3 ? `${f.values.slice(0, 3).join(', ')}, ...` : f.values.join(', ');
                const label = `${f.dimension}: ${getConditionLabel(f.condition)}: ${valuesDisplay}`;
                const filterTag = document.createElement('div');
                filterTag.className = 'px-3 py-2 bg-green-100 text-green-800 rounded-lg flex justify-between items-center text-sm font-medium';
                filterTag.innerHTML = `
                    <span>${label}</span>
                    <button class="remove-condition-filter-btn ml-3 text-red-600 hover:text-red-800" data-filter-id="${f.id}">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                `;
                activeFiltersList.appendChild(filterTag);
            });
            
            // Re-attach event listeners
            activeFiltersList.querySelectorAll('.remove-condition-filter-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const filterId = parseInt(e.currentTarget.dataset.filterId);
                    removeDimensionFilter(filterId);
                });
            });

            // Update badge count
            const count = activeDimensionFilters.length;
            if (count > 0) {
                 el.filterCountBadge.textContent = count;
                 // Set Filter button to active state
                 el.openFilterModalBtn.classList.add('filter-button-active');
                 el.openFilterModalBtn.classList.remove('filter-button-default');
                 el.filterCountBadge.classList.remove('hidden');
                 el.openFilterModalBtn.querySelector('svg').style.stroke = 'currentColor'; // Use button's current text color
            } else {
                 // Reset button state
                 el.openFilterModalBtn.classList.add('filter-button-default');
                 el.openFilterModalBtn.classList.remove('filter-button-active');
                 el.filterCountBadge.classList.add('hidden');
                 el.openFilterModalBtn.querySelector('svg').style.stroke = '#475569'; // Reset SVG color to default slate
            }
        }
        
        /**
         * Filters data by date and dimension criteria.
         */
        function filterDataByDateAndDimensions(data, dateRangeString) {
             let [startDate, endDate] = dateRangeString.split(' to ');

            return data.filter(d => {
                const rowDate = d.date; // Use the normalized 'date' field
                
                // Date Filter
                if (startDate && endDate) {
                    if (!(rowDate >= startDate && rowDate <= endDate)) return false;
                } else if (startDate) { // Single date selected
                    if (rowDate !== startDate) return false;
                }
                
                // Dimension Filters
                const passesDimensionFilters = activeDimensionFilters.every(filter => {
                    const rowValue = String(d[filter.dimension] || '');
                    const filterValues = filter.values;

                    // Check if row value matches any of the filter's values (OR logic)
                    return filterValues.some(val => {
                        switch (filter.condition) {
                            case 'contains':
                                return rowValue.toLowerCase().includes(val.toLowerCase());
                            case 'not_contains':
                                return !rowValue.toLowerCase().includes(val.toLowerCase());
                            case 'exact_match':
                                return rowValue === val;
                            case 'not_exact_match':
                                return rowValue !== val;
                            case 'starts_with':
                                return rowValue.toLowerCase().startsWith(val.toLowerCase());
                            case 'ends_with':
                                return rowValue.toLowerCase().endsWith(val.toLowerCase());
                            default:
                                return true; 
                        }
                    });
                });

                if (!passesDimensionFilters) return false;
                
                return true;
            });
        }


        function applyGlobalFilters() {
            // Smartly update comparison date range based on the main date range
            if (headerFlatpickr.selectedDates.length === 2) {
                const [mainStart, mainEnd] = headerFlatpickr.selectedDates;
                const durationMs = mainEnd.getTime() - mainStart.getTime();
                
                const comparisonEnd = new Date(mainStart.getTime() - (24 * 60 * 60 * 1000)); // One day before mainStart
                const comparisonStart = new Date(comparisonEnd.getTime() - durationMs);

                if (comparisonFlatpickr) {
                    comparisonFlatpickr.setDate([comparisonStart, comparisonEnd], false);
                    // Manually update the display and state as setDate with `false` doesn't trigger onClose
                    const dateStr = comparisonFlatpickr.formatDate(comparisonStart, "Y-m-d") + ' to ' + comparisonFlatpickr.formatDate(comparisonEnd, "Y-m-d");
                    el.comparisonDateRangeDisplay.textContent = dateStr;
                    comparisonState.period2Range = [comparisonStart, comparisonEnd];
                }
            }

            // Main filtering for Period 1
            filteredData = filterDataByDateAndDimensions(allData, el.headerDateFilterInput.value);


            console.log(`Filtering complete. ${filteredData.length} rows remaining.`);
            
            // Update Filter Button UI
            const dimensionFilterCount = activeDimensionFilters.length;
             
            const isDateFilterActive = (() => {
                 const dateRange = el.headerDateFilterInput.value;
                 if (!dateRange || allData.length === 0) return false;
                 
                 const dates = allData.map(d => new Date(d.date)).filter(d => !isNaN(d));
                 if (dates.length === 0) return false;

                 const minDate = new Date(Math.min.apply(null, dates));
                 const maxDate = new Date(Math.max.apply(null, dates));
                 
                 const [startStr, endStr] = dateRange.split(' to ');
                 
                 if (!startStr || !endStr) return false;

                 const minStr = minDate.toISOString().split('T')[0];
                 const maxStr = maxDate.toISOString().split('T')[0];
                 
                 return startStr !== minStr || endStr !== maxStr;
             })();
             
             const isFilterActive = dimensionFilterCount > 0 || isDateFilterActive;


            if (isFilterActive) {
                 el.openFilterModalBtn.classList.add('filter-button-active');
                 el.openFilterModalBtn.classList.remove('filter-button-default');
                 
                 if (dimensionFilterCount > 0) {
                     el.filterCountBadge.textContent = dimensionFilterCount;
                     el.filterCountBadge.classList.remove('hidden');
                 } else {
                     el.filterCountBadge.classList.add('hidden');
                 }
                 
                 el.openFilterModalBtn.querySelector('svg').style.stroke = 'currentColor'; 
            } else {
                 el.openFilterModalBtn.classList.add('filter-button-default');
                 el.openFilterModalBtn.classList.remove('filter-button-active');
                 el.filterCountBadge.classList.add('hidden');
                 el.openFilterModalBtn.querySelector('svg').style.stroke = '#475569'; 
            }

            const currentPage = document.querySelector('.app-page:not(.hidden)');
            if (currentPage && currentPage.id !== 'home-page') {
                 renderDashboardPage(currentPage.id);
            }
           
            el.filterModal.classList.add('hidden');
            el.filterModal.classList.remove('flex');
        }

        function resetGlobalFilters() {
            // Reset Date Range to the full range of the data
            const dates = allData.map(d => new Date(d.date)).filter(d => !isNaN(d));
            let maxMinDateRange = [];
             if (dates.length > 0) {
                const minDate = new Date(Math.min.apply(null, dates));
                const maxDate = new Date(Math.max.apply(null, dates));
                maxMinDateRange = [minDate, maxDate];
            }
            headerFlatpickr.setDate(maxMinDateRange, true); 

            // Reset Dimension Filters
            activeDimensionFilters = [];
            renderActiveDimensionFilters();
            
            // Re-apply filters
            applyGlobalFilters();
        }
        
        // --- Target Setting ---
        function setupTargetSelect() {
            el.targetMeasureSelect.innerHTML = '';
            el.targetMeasureSelect.innerHTML += `<option value="">(None)</option>`; // Initial empty option
            templateConfig.measures.forEach(m => {
                el.targetMeasureSelect.innerHTML += `<option value="${m.name}">${m.name}</option>`;
            });
            
            // Restore previous target if it still exists in measures
            if (globalTarget.measureName && templateConfig.measures.some(m => m.name === globalTarget.measureName)) {
                 el.targetMeasureSelect.value = globalTarget.measureName;
                 el.targetValueInput.value = globalTarget.value !== null ? globalTarget.value : '';
            } else {
                 globalTarget = { measureName: '', value: null };
                 el.targetMeasureSelect.value = '';
                 el.targetValueInput.value = '';
            }
        }
        
        function handleTargetChange() {
            const measureName = el.targetMeasureSelect.value;
            const value = parseFloat(el.targetValueInput.value);
            
            if (measureName && !isNaN(value) && value >= 0) {
                 globalTarget.measureName = measureName;
                 globalTarget.value = value;
            } else {
                 globalTarget.measureName = '';
                 globalTarget.value = null;
                 el.targetValueInput.value = '';
                 // If measure is set to (None), reset everything.
                 if (measureName === '') {
                    el.targetValueInput.value = '';
                 }
            }
            
            // Re-render dashboard page to reflect target changes
            const currentPage = document.querySelector('.app-page:not(.hidden)');
            if (currentPage && currentPage.id !== 'home-page') {
                 renderDashboardPage(currentPage.id);
            }
        }
        
        // --- PAGE RENDERING ---

        function formatNumber(num, format = 'number', showSign = false) { // showSign parameter for +/-
            const texts = uiTexts[currentLanguage];
            if (num === undefined || num === null || isNaN(num)) {
                switch(format) {
                    case 'currency': return (currentCurrency === 'JPY' ? '¥' : '$') + '0';
                    case 'percent': return '0.00%';
                    default: return '0';
                }
            }
            
            // Determine sign
            let signPrefix = '';
            if (showSign) {
                if (num > 0) signPrefix = '+';
                else if (num < 0) signPrefix = '-';
            } else if (num < 0) {
                signPrefix = '-';
            }
            
            const absNum = Math.abs(num);
            let formattedNum;

            switch(format) {
                case 'currency':
                    const symbol = currentCurrency === 'JPY' ? '¥' : '$';
                    formattedNum = Math.round(absNum).toLocaleString(currentLanguage);
                    return signPrefix + symbol + formattedNum;
                case 'percent':
                    formattedNum = (absNum * 100).toFixed(2);
                    return signPrefix + formattedNum + '%';
                case 'decimal':
                    formattedNum = absNum.toFixed(2);
                    return signPrefix + formattedNum.toLocaleString(currentLanguage);
                case 'number':
                default:
                    // Use localized string formatting for large numbers
                    if (absNum >= 1000 || absNum < 1) {
                         formattedNum = absNum.toLocaleString(currentLanguage, { minimumFractionDigits: 0, maximumFractionDigits: 2 });
                    } else {
                         formattedNum = absNum.toLocaleString(currentLanguage);
                    }
                    return signPrefix + formattedNum;
            }
        }
        

        function renderDashboardPage(pageId) {
            const container = document.getElementById(pageId);
            if (!container) return;

            // Destroy old charts
            Object.values(charts).forEach(chart => chart.destroy());
            charts = {};
            if (customChartInstance) {
                customChartInstance.destroy();
                customChartInstance = null;
            }
            if (comparisonChartInstance) {
                comparisonChartInstance.destroy();
                comparisonChartInstance = null;
            }

            // Clear content for pages that are fully re-rendered each time.
            // The comparison page has static HTML and should not be cleared.
            if (pageId === 'dashboard-page' || pageId === 'daily-page' || pageId === 'custom-page') {
                container.innerHTML = '';
            }

            if (filteredData.length === 0 && pageId !== 'home-page') {
                container.innerHTML = `<div class="p-1 bg-gradient-to-r from-yellow-400 to-orange-500 rounded-xl shadow-lg"><div class="bg-white rounded-lg p-8"><h2 class="text-2xl font-bold">No Data</h2><p>${uiTexts[currentLanguage].filterApply}: No data available for the current filter selection. Please adjust your filters.</p></div></div>`;
                translateElements(container);
                return;
            }
            

            switch(pageId) {
                case 'dashboard-page':
                renderSummaryDashboard(container);
                break;
            case 'daily-page':
                renderDailyPage(container);
                break;
            case 'comparison-page': // Don't clear inner HTML, just render the table
                renderComparisonPage(container);
                break;
            case 'custom-page':
                renderCustomReportPage(container);
                break;
                default:
                container.innerHTML = `<div class="p-1 bg-gradient-to-r from-green-500 to-emerald-500 rounded-xl shadow-lg"><div class="bg-white rounded-lg p-8"><h2 class="text-2xl font-bold">${pageId}</h2><p>This page is under construction.</p></div></div>`;
            }
            
            translateElements(container);
        }
        
        // --- Data Grouping Helper ---
        function groupAndCalculateData(rawData, groupByDimension) {
            const measureConfigs = templateConfig.measures;
            const baseMeasures = new Set();
            measureConfigs.forEach(m => {
                if (m.operand1) {
                    baseMeasures.add(m.operand1);
                    baseMeasures.add(m.operand2);
                } else {
                    baseMeasures.add(m.name);
                }
            });
            
            const groupedData = rawData.reduce((acc, row) => {
                const key = row[groupByDimension] || '(empty)';
                if (!acc[key]) {
                    acc[key] = { [groupByDimension]: key };
                    baseMeasures.forEach(bm => acc[key][bm] = 0);
                }
                // Sum base measures
                baseMeasures.forEach(bm => acc[key][bm] += (row[bm] || 0));
                return acc;
            }, {});

            // Calculate final measures, including calculated fields
            Object.values(groupedData).forEach(group => {
                measureConfigs.forEach(m => {
                    if (m.operand1) {
                        const op1 = group[m.operand1] || 0; 
                        const op2 = group[m.operand2] || 0;
                        let result = 0;
                        switch(m.operator) {
                            case '/': result = op2 !== 0 ? op1 / op2 : 0; break;
                            case '*': result = op1 * op2; break;
                            case '+': result = op1 + op2; break;
                            case '-': result = op1 - op2; break;
                        }
                        group[m.name] = result;
                    }
                });
            });
            
            return groupedData;
        }

        // --- Reusable Trend Chart ---
        function renderTrendAnalysisChart(canvasId, metric1SelectId, metric2SelectId, rawData = filteredData) {
            const allMetrics = templateConfig.measures.map(m => m.name);
            const measureConfigs = templateConfig.measures;
            
            const trendDataGrouped = groupAndCalculateData(rawData, 'date');

            // Sort by date
            const sortedTrendData = Object.values(trendDataGrouped).sort((a,b) => new Date(a.date) - new Date(b.date));

            const metric1Select = document.getElementById(metric1SelectId);
            const metric2Select = document.getElementById(metric2SelectId);
            
            metric1Select.classList.add('custom-select', 'bg-white', 'border', 'border-slate-300', 'text-slate-700', 'px-3', 'py-1');
            metric2Select.classList.add('custom-select', 'bg-white', 'border', 'border-slate-300', 'text-slate-700', 'px-3', 'py-1');

            metric1Select.innerHTML = '';
            metric2Select.innerHTML = '';
            allMetrics.forEach(m => {
                metric1Select.innerHTML += `<option value="${m}">${m}</option>`;
                metric2Select.innerHTML += `<option value="${m}">${m}</option>`;
            });

            metric1Select.value = allMetrics.find(m => m.toLowerCase().includes('cost') || m.toLowerCase().includes('費用')) || allMetrics[0];
            metric2Select.value = allMetrics.find(m => m.toLowerCase() === 'cpa') || allMetrics.find(m => m.toLowerCase().includes('cv')) || allMetrics[1] || allMetrics[0];
            
            const renderChart = () => {
                const chartKey = `trend-${canvasId}`;
                if (charts[chartKey]) charts[chartKey].destroy();
                
                const metric1 = metric1Select.value;
                const metric2 = metric2Select.value;
                const canvas = document.getElementById(canvasId);
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                
                // Get measure formats for tooltips
                const format1 = measureConfigs.find(m => m.name === metric1)?.format || 'number';
                const format2 = measureConfigs.find(m => m.name === metric2)?.format || 'number';

                charts[chartKey] = new Chart(ctx, {
                    type: 'line',
                    data: {
                        datasets: [
                            { 
                                label: metric1, 
                                data: sortedTrendData.map(d => ({ x: d.date, y: d[metric1] })), 
                                borderColor: '#328E6E',
                                yAxisID: 'y', 
                                tension: 0.1,
                                backgroundColor: 'rgba(50, 142, 110, 0.5)'
                            }, 
                            { 
                                label: metric2, 
                                data: sortedTrendData.map(d => ({ x: d.date, y: d[metric2] })), 
                                borderColor: '#67AE6E',
                                yAxisID: 'y1', 
                                tension: 0.1,
                                backgroundColor: 'rgba(103, 174, 110, 0.5)'
                            }
                        ]
                    },
                    options: { 
                        maintainAspectRatio: false, 
                        scales: { 
                            x: { 
                                type: 'time', 
                                time: { 
                                    unit: 'day',
                                    displayFormats: { day: 'yy/MM/dd' },
                                    tooltipFormat: 'yy/MM/dd' 
                                } 
                            }, 
                            y: { 
                                position: 'left',
                                ticks: {
                                     callback: (value) => formatNumber(value, format1)
                                }
                            }, 
                            y1: { 
                                position: 'right', 
                                grid: { drawOnChartArea: false },
                                ticks: {
                                    callback: (value) => formatNumber(value, format2)
                                }
                            } 
                        },
                         plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        const value = context.parsed.y;
                                        const format = context.dataset.yAxisID === 'y' ? format1 : format2;
                                        label += formatNumber(value, format);
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            };
            
            renderChart();
            metric1Select.addEventListener('change', renderChart);
            metric2Select.addEventListener('change', renderChart);
        }

        function renderSummaryDashboard(container) {
            // Add gradient border wrapper to all cards
            container.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                    <div class="p-1 bg-gradient-to-r from-green-500 to-emerald-500 rounded-xl shadow-lg lg:col-span-2">
                        <div class="bg-white p-6 rounded-lg">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="font-bold" data-i18n="summaryTrendAnalysis"></h3>
                                <div class="flex flex-col gap-2">
                                    <select id="summary-trend-metric1" class="text-sm rounded-lg border-slate-300"></select>
                                    <select id="summary-trend-metric2" class="text-sm rounded-lg border-slate-300"></select>
                                </div>
                            </div>
                            <div class="relative h-80">
                                <canvas id="summary-trend-chart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="p-1 bg-gradient-to-r from-green-500 to-emerald-500 rounded-xl shadow-lg">
                        <div class="bg-white p-6 rounded-lg">
                            <h3 id="pie-chart-1-title" class="font-bold mb-4"></h3>
                            <div class="relative h-80">
                                <canvas id="media-cost-pie-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="p-1 bg-gradient-to-r from-green-500 to-emerald-500 rounded-xl shadow-lg">
                    <div class="bg-white p-6 rounded-lg">
                        <div class="flex items-center gap-4 mb-4">
                            <h2 class="text-xl font-bold" data-i18n="summaryDetailsTitle"></h2>
                            <div class="flex items-center gap-2">
                                <label for="summary-group-by-select" class="font-semibold text-sm" data-i18n="groupBy"></label>
                                <select id="summary-group-by-select" class="custom-select bg-white border border-slate-300 text-slate-700 text-sm rounded-lg focus:ring-green-500 focus:border-green-500 block px-3 py-1"></select>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table id="summary-details-table" class="w-full text-sm text-left whitespace-nowrap"></table>
                        </div>
                    </div>
                </div>
            `;
            
            renderTrendAnalysisChart('summary-trend-chart', 'summary-trend-metric1', 'summary-trend-metric2', filteredData);

            const measureConfigs = templateConfig.measures;
            const costMeasure = measureConfigs.find(m => m.name.toLowerCase().includes('cost') || m.name.toLowerCase().includes('費用'));
            
            const firstDimension = templateConfig.dimensions[0] || 'date';
            const groupedData = groupAndCalculateData(filteredData, firstDimension);
            
            const mediaData = Object.values(groupedData);

            const mediaLabels = mediaData.map(d => d[firstDimension]);
            const costData = costMeasure ? mediaData.map(m => m[costMeasure.name] || 0) : [];
            const costFormat = costMeasure ? costMeasure.format : 'number';

            const pieOptions = { 
                responsive: true, 
                maintainAspectRatio: false, 
                plugins: { 
                    legend: { display: mediaLabels.length < 10 },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed !== null) {
                                    label += formatNumber(context.parsed, costFormat);
                                }
                                return label;
                            }
                        }
                    }
                } 
            };

            if(charts.mediaCost) charts.mediaCost.destroy();
            const pieCanvas = document.getElementById('media-cost-pie-chart');
             if (pieCanvas) {
                charts.mediaCost = new Chart(pieCanvas.getContext('2d'), { type: 'pie', data: { labels: mediaLabels, datasets: [{ data: costData, backgroundColor: CHART_COLORS_PASTEL }] }, options: pieOptions });
            } // Use pastel colors

            const pieTitleEl = document.getElementById('pie-chart-1-title');
            if (pieTitleEl) { 
                pieTitleEl.textContent = uiTexts[currentLanguage].summaryPieCost.replace('{dimension}', firstDimension);
            }

            const groupBySelect = document.getElementById('summary-group-by-select');
            groupBySelect.innerHTML = '';
            templateConfig.dimensions.filter(d => d).forEach(dim => { // Filter null/empty dimensions
                groupBySelect.innerHTML += `<option value="${dim}">${dim}</option>`; // Filter null/empty dimensions
            });
            // Ensure select has a value
            if (!groupBySelect.value && templateConfig.dimensions.length > 0) {
                 groupBySelect.value = templateConfig.dimensions[0];
            }

            const renderSummaryTable = (groupByDimension) => {
                const table = document.getElementById('summary-details-table');
                if (!table) return; 
                
                const measureHeaders = measureConfigs.map(m => m.name);
                const allHeaders = [groupByDimension, ...measureHeaders];
                
                let headerHTML = '<tr>';
                allHeaders.forEach(h => {
                    let colName = h;
                    if (globalTarget.measureName === h && globalTarget.value !== null) {
                        colName = `${h} / ${uiTexts[currentLanguage].headerTargetMeasureLabel}`; 
                    }
                    const isSortable = allHeaders.includes(h);
                    const sortableClass = isSortable ? 'sortable-header cursor-pointer' : '';
                    const alignClass = measureHeaders.includes(h) ? 'text-right' : 'text-left';
                    headerHTML += `<th class="p-3 bg-slate-50 ${alignClass} font-semibold ${sortableClass}" data-column-id="${h}">${colName}<span class="sort-indicator"></span></th>`;
                });
                headerHTML += '</tr>';
                
                const groupedData = groupAndCalculateData(filteredData, groupByDimension);

                let tableBodyHTML = '';
                let dataToRender = Object.values(groupedData);

                // Sorting Logic
                if (sortState.column && allHeaders.includes(sortState.column)) {
                    dataToRender.sort((a, b) => {
                        const valA = getSortValue(a, sortState.column);
                        const valB = getSortValue(b, sortState.column);
                        
                        if (valA < valB) return sortState.direction === 'asc' ? -1 : 1;
                        if (valA > valB) return sortState.direction === 'asc' ? 1 : -1;
                        return 0;
                    });
                }

                dataToRender.forEach(group => {
                    let rowHTML = '<tr class="border-b hover:bg-slate-50">';
                    allHeaders.forEach(header => {
                        const isMeasure = measureHeaders.includes(header);
                        const value = group[header];
                        const measureConfig = isMeasure ? measureConfigs.find(m => m.name === header) : null;
                        const format = measureConfig ? measureConfig.format : 'number';
                        const alignClass = isMeasure ? 'text-right' : 'text-left';
                        let cellContent;

                        if (isMeasure) { // Target comparison for Summary Table
                            cellContent = formatNumber(value, format);
                            // --- Target comparison for Summary Table ---
                            if (header === globalTarget.measureName && globalTarget.value !== null && globalTarget.value > 0) {
                                const target = globalTarget.value;
                                const percentageRatio = (value / target) * 100;
                                const lowerIsBetterFlag = isLowerIsBetter(header);
                                
                                let indicatorClass;

                                if (lowerIsBetterFlag) {
                                    if (percentageRatio <= 100) {
                                        indicatorClass = 'text-green-600 bg-green-100';
                                    } else if (percentageRatio <= 125) {
                                        indicatorClass = 'text-yellow-700 bg-yellow-100';
                                    } else {
                                        indicatorClass = 'text-red-600 bg-red-100';
                                    }
                                } else {
                                    if (percentageRatio >= 100) {
                                        indicatorClass = 'text-green-600 bg-green-100';
                                    } else if (percentageRatio >= 75) {
                                        indicatorClass = 'text-yellow-700 bg-yellow-100';
                                    } else {
                                        indicatorClass = 'text-red-600 bg-red-100';
                                    }
                                }

                                cellContent = `
                                    <div class="flex flex-col items-end">
                                        <span class="font-semibold">${formatNumber(value, format)}</span>
                                        <span class="text-xs font-medium ${indicatorClass} rounded-full px-2 mt-0.5">${percentageRatio.toFixed(1)}%</span>
                                    </div>
                                `;
                            }
                            rowHTML += `<td class="p-3 ${alignClass}">${cellContent}</td>`;
                        } else {
                            rowHTML += `<td class="p-3 text-left">${value || ''}</td>`;
                        }
                    });
                    rowHTML += '</tr>';
                    tableBodyHTML += rowHTML;
                });

                const totals = calculateTotals(filteredData);

                let totalRowHTML = `<tr class="border-t-2 border-slate-300 font-bold bg-slate-100"><td class="p-3">${uiTexts[currentLanguage].tableTotal}</td>`;
                measureHeaders.forEach(header => {
                    const measureConfig = measureConfigs.find(m => m.name === header);
                    const format = measureConfig ? measureConfig.format : 'number';
                    let totalContent = formatNumber(totals[header], format);

                    if (header === globalTarget.measureName && globalTarget.value !== null && globalTarget.value > 0) {
                        const target = globalTarget.value;
                        const percentageRatio = (totals[header] / target) * 100;
                        const lowerIsBetterFlag = isLowerIsBetter(header);
                        let indicatorClass;

                        if (lowerIsBetterFlag) {
                            if (percentageRatio <= 100) {
                                indicatorClass = 'text-green-600 bg-green-100';
                            } else if (percentageRatio <= 125) {
                                indicatorClass = 'text-yellow-700 bg-yellow-100';
                            } else {
                                indicatorClass = 'text-red-600 bg-red-100';
                            }
                        } else {
                            if (percentageRatio >= 100) {
                                indicatorClass = 'text-green-600 bg-green-100';
                            } else if (percentageRatio >= 75) {
                                indicatorClass = 'text-yellow-700 bg-yellow-100';
                            } else {
                                indicatorClass = 'text-red-600 bg-red-100';
                            }
                        }
                        totalContent = `
                            <div class="flex flex-col items-end">
                                <span class="font-bold">${formatNumber(totals[header], format)}</span>
                                <span class="text-xs font-extrabold ${indicatorClass} rounded-full px-2 mt-0.5">${percentageRatio.toFixed(1)}%</span>
                            </div>
                        `;
                    }
                    totalRowHTML += `<td class="p-3 text-right">${totalContent}</td>`;
                });
                totalRowHTML += '</tr>';
                
                table.innerHTML = `
                    <thead class="sticky top-0">${headerHTML}</thead>
                    <tbody>${tableBodyHTML}</tbody>
                    <tfoot>${totalRowHTML}</tfoot>
                `;
                // --- FIX: Add Sort Listeners and Indicators ---
                table.querySelectorAll('.sortable-header').forEach(th => {
                    const columnId = th.dataset.columnId;
                    const indicator = th.querySelector('.sort-indicator');

                    if (sortState.column === columnId) {
                        th.classList.add('active');
                        indicator.innerHTML = sortState.direction === 'asc' ? '&#9650;' : '&#9660;'; // Up/Down arrow
                    } // Up/Down arrow

                    th.addEventListener('click', () => {
                        if (window.isResizing) return; // FIX: Prevent sort when resizing
                        if (sortState.column === columnId) {
                            sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
                        } else {
                            sortState.column = columnId;
                            sortState.direction = 'asc';
                        }
                        renderSummaryTable(groupByDimension); // Re-render the table
                    });
                });

                // Apply resizable functionality
                makeColumnsResizable(table);
            };

            // Re-render table on selection change
            groupBySelect.addEventListener('change', (e) => {
                renderSummaryTable(e.target.value);
            });

            // Initial table render
            renderSummaryTable(groupBySelect.value);

        }
        
        /**
         * Calculates total measures for a given dataset.
         * @param {Array<Object>} data The data set (e.g., filteredData or a subset).
         * @returns {Object<string, number>} Object with measure totals.
         */
        function calculateTotals(data) {
            const measureConfigs = templateConfig.measures;
            const baseMeasures = new Set();
            measureConfigs.forEach(m => {
                if (m.operand1) {
                    baseMeasures.add(m.operand1);
                    baseMeasures.add(m.operand2);
                } else {
                    baseMeasures.add(m.name);
                }
            });
            
            const totals = {};
            baseMeasures.forEach(bm => totals[bm] = 0);
            data.forEach(row => { baseMeasures.forEach(bm => totals[bm] += (row[bm] || 0)); });
            
            measureConfigs.forEach(m => {
                if (m.operand1) {
                    const op1 = totals[m.operand1] || 0; 
                    const op2 = totals[m.operand2] || 0;
                    let result = 0;
                    switch(m.operator) {
                        case '/': result = op2 !== 0 ? op1 / op2 : 0; break;
                        case '*': result = op1 * op2; break;
                        case '+': result = op1 + op2; break;
                        case '-': result = op1 - op2; break;
                    }
                    totals[m.name] = result;
                }
            });
            return totals;
        }

        function renderDailyPage(container) {
             container.innerHTML = `
                <div class="p-1 bg-gradient-to-r from-green-500 to-emerald-500 rounded-xl shadow-lg lg:col-span-2 mb-6">
                    <div class="bg-white p-6 rounded-lg">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold" data-i18n="summaryTrendAnalysis">トレンド分析</h3>
                            <div class="flex flex-col gap-2">
                                <select id="daily-trend-metric1" class="text-sm rounded-lg border-slate-300"></select>
                                <select id="daily-trend-metric2" class="text-sm rounded-lg border-slate-300"></select>
                            </div>
                        </div>
                        <div class="relative h-80">
                            <canvas id="daily-trend-chart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="p-1 bg-gradient-to-r from-green-500 to-emerald-500 rounded-xl shadow-lg">
                    <div class="bg-white p-6 rounded-lg">
                        <h2 class="text-xl font-bold mb-4" data-i18n="dailyTitle">日別レポート</h2>
                        <div class="overflow-x-auto">
                            <table id="daily-details-table" class="w-full text-sm text-left whitespace-nowrap"></table>
                        </div>
                    </div>
                </div>
            `;

            renderTrendAnalysisChart('daily-trend-chart', 'daily-trend-metric1', 'daily-trend-metric2', filteredData);

            const table = document.getElementById('daily-details-table');
            if (!table) return;

            const measureConfigs = templateConfig.measures;
            const measureHeaders = measureConfigs.map(m => m.name);
            
            const groupedData = groupAndCalculateData(filteredData, 'date');

            let headerHTML = '<tr>'; // Added translation
            headerHTML += `<th class="p-3 bg-slate-50 text-left font-semibold" data-i18n="dailyDateHeader">${uiTexts[currentLanguage].dailyDateHeader}</th>`;
            measureHeaders.forEach(h => {
                let colName = h;
                if (globalTarget.measureName === h && globalTarget.value !== null) {
                   colName = `${h} / ${uiTexts[currentLanguage].headerTargetMeasureLabel}`;
                }
                headerHTML += `<th class="p-3 bg-slate-50 text-right font-semibold">${colName}</th>`;
            });
            headerHTML += '</tr>';
            
            let sortedData = Object.values(groupedData).sort((a, b) => {
                if (a.date < b.date) return -1;
                if (a.date > b.date) return 1;
                return 0;
            });

            let tableBodyHTML = '';
            sortedData.forEach(group => {
                let rowHTML = '<tr class="border-b hover:bg-slate-50">';
                rowHTML += `<td class="p-3 text-left">${group.date}</td>`;
                
                measureHeaders.forEach(header => {
                    const value = group[header];
                    const measureConfig = measureConfigs.find(m => m.name === header);
                    const format = measureConfig ? measureConfig.format : 'number';
                    const alignClass = 'text-right';
                    let cellContent;

                    if (header === globalTarget.measureName && globalTarget.value !== null && globalTarget.value > 0) {
                        const target = globalTarget.value;
                        const percentageRatio = (value / target) * 100;
                        const lowerIsBetterFlag = isLowerIsBetter(header);

                        let indicatorClass;
                        
                        if (lowerIsBetterFlag) {
                            if (percentageRatio <= 100) {
                                indicatorClass = 'text-green-600 bg-green-100';
                            } else if (percentageRatio <= 125) {
                                indicatorClass = 'text-yellow-700 bg-yellow-100';
                            } else {
                                indicatorClass = 'text-red-600 bg-red-100';
                            }
                        } else {
                            if (percentageRatio >= 100) {
                                indicatorClass = 'text-green-600 bg-green-100';
                            } else if (percentageRatio >= 75) {
                                indicatorClass = 'text-yellow-700 bg-yellow-100';
                            } else {
                                indicatorClass = 'text-red-600 bg-red-100';
                            }
                        }

                        cellContent = `
                            <div class="flex flex-col items-end">
                                <span class="font-semibold">${formatNumber(value, format)}</span>
                                <span class="text-xs font-medium ${indicatorClass} rounded-full px-2 mt-0.5">${percentageRatio.toFixed(1)}%</span>
                            </div>
                        `;
                    } else {
                        cellContent = formatNumber(value, format);
                    }

                    rowHTML += `<td class="p-3 ${alignClass}">${cellContent}</td>`;
                });
                rowHTML += '</tr>';
                tableBodyHTML += rowHTML;
            });

            // Calculate Totals
            const totals = calculateTotals(filteredData);

            let totalRowHTML = `<tr class="border-t-2 border-slate-300 font-bold bg-slate-100"><td class="p-3" data-i18n="tableTotal">${uiTexts[currentLanguage].tableTotal}</td>`;
            measureHeaders.forEach(header => {
                const measureConfig = measureConfigs.find(m => m.name === header);
                const format = measureConfig ? measureConfig.format : 'number';
                
                let totalContent = formatNumber(totals[header], format);
                
                if (header === globalTarget.measureName && globalTarget.value !== null && globalTarget.value > 0) {
                    const target = globalTarget.value;
                    const percentageRatio = (totals[header] / target) * 100;
                    const lowerIsBetterFlag = isLowerIsBetter(header);

                    let indicatorClass;

                    if (lowerIsBetterFlag) {
                        if (percentageRatio <= 100) {
                            indicatorClass = 'text-green-600 bg-green-100';
                        } else if (percentageRatio <= 125) {
                            indicatorClass = 'text-yellow-700 bg-yellow-100';
                        } else {
                            indicatorClass = 'text-red-600 bg-red-100';
                        }
                    } else {
                        if (percentageRatio >= 100) {
                            indicatorClass = 'text-green-600 bg-green-100';
                        } else if (percentageRatio >= 75) {
                            indicatorClass = 'text-yellow-700 bg-yellow-100';
                        } else {
                            indicatorClass = 'text-red-600 bg-red-100';
                        }
                    }
                    
                    totalContent = `
                        <div class="flex flex-col items-end">
                            <span class="font-bold">${formatNumber(totals[header], format)}</span>
                            <span class="text-xs font-extrabold ${indicatorClass} rounded-full px-2 mt-0.5">${percentageRatio.toFixed(1)}%</span>
                        </div>
                    `;
                }
                
                totalRowHTML += `<td class="p-3 text-right">${totalContent}</td>`;
            });
            totalRowHTML += '</tr>';
            
            table.innerHTML = `
                <thead class="sticky top-0">${headerHTML}</thead>
                <tbody>${tableBodyHTML}</tbody>
                <tfoot>${totalRowHTML}</tfoot>
            `;

            makeColumnsResizable(table);
        }
        
        // --- NEW: COMPARISON PAGE RENDERING ---

        function renderComparisonPage(container) {
            const texts = uiTexts[currentLanguage];
            const customizeBtn = container.querySelector('#customize-comparison-btn');

            // 2. GẮN LISTENERS (Đảm bảo chỉ gắn 1 lần)
            if (!container.hasAttribute('data-comparison-listeners-added')) { // Attach listeners only once
                if (customizeBtn) {
                    sortState = { column: null, direction: 'asc' }; // Reset sort on first load
                    customizeBtn.addEventListener('click', openComparisonCustomizeModal);
                }
                el.toggleComparisonViewBtn.addEventListener('click', () => {
                    comparisonState.isPivotView = !comparisonState.isPivotView;
                    renderComparisonPage(container); 
                });
                container.setAttribute('data-comparison-listeners-added', 'true');
            }

            // 5. Update toggle button text
            const toggleBtnSpan = el.toggleComparisonViewBtn.querySelector('span'); // Update toggle button text
            toggleBtnSpan.textContent = comparisonState.isPivotView ? texts.comparisonViewPivot : texts.comparisonViewFlat;
            
            // 6. GỌI RENDER BẢNG
            renderComparisonTable(); // Render the table
        }
        
        function renderComparisonTable() {
            const tableContainer = el.comparisonReportTableContainer;
            tableContainer.innerHTML = ''; 

            const measureConfigs = templateConfig.measures;
            const allMeasureHeaders = measureConfigs.map(m => m.name);
            
            // Lấy measures đã chọn từ config
            const selectedMeasureHeaders = comparisonReportConfig.measures.filter(m => allMeasureHeaders.includes(m)); // Get selected measures from config

            const groupByDimension = comparisonReportConfig.dimensions[0];
            const isPivot = comparisonState.isPivotView;
            const texts = uiTexts[currentLanguage];

            if (!groupByDimension || selectedMeasureHeaders.length === 0) {
                tableContainer.innerHTML = `<p class="text-slate-500 text-center py-8">Please select at least one dimension and one measure to display by clicking the 'Customize Columns' button.</p>`;
                return;
            }
            
            // 1. Filter data for Period 1 (Global) and Period 2 (Comparison)
            const period1RangeStr = el.headerDateFilterInput.value; // Period 1 data is already filtered into `filteredData`
            const period2RangeStr = el.comparisonDateFilterInput.value;
            
            // Period 1 data is already filtered into `filteredData`
            const dataP1 = filteredData; // Period 2 data must be filtered from `allData` using its own date range
            // Period 2 data must be filtered from `allData` using its own date range
            const dataP2 = filterDataByDateAndDimensions(allData, period2RangeStr); 

            // 2. Group and calculate data for each period
            const groupedP1 = groupAndCalculateData(dataP1, groupByDimension); // Group and calculate data for each period
            const groupedP2 = groupAndCalculateData(dataP2, groupByDimension);
            
            const allKeys = new Set([...Object.keys(groupedP1), ...Object.keys(groupedP2)]);
            
            if (allKeys.size === 0) {
                tableContainer.innerHTML = `<p class="text-slate-500 text-center py-8">No data found in either Period 1 or Period 2 for the selected criteria.</p>`;
                return;
            }

            // --- Pivot View (Giống Image 1) ---
            if (isPivot) { // Pivot View
                const table = document.createElement('table');
                table.id = 'comparison-table-pivot';
                table.className = 'w-full text-sm text-left whitespace-nowrap';

                let headerHTML = '<thead><tr>';
                // Row 1: Dimension Header & Merged Measure Headers
                headerHTML += `<th rowspan="2" class="p-3 bg-slate-50 text-left font-semibold sticky left-0 z-10 sortable-header cursor-pointer" data-column-id="${groupByDimension}">${groupByDimension}<span class="sort-indicator"></span></th>`;
                
                selectedMeasureHeaders.forEach(measureName => {
                    headerHTML += `<th colspan="3" class="p-3 bg-slate-200 text-center font-semibold border-l border-slate-300">${measureName}</th>`;
                });
                headerHTML += '</tr>';

                // Row 2: Period & Difference Headers
                headerHTML += '<tr>';
                selectedMeasureHeaders.forEach(() => {
                    headerHTML += `
                        <th class="p-3 bg-slate-50 text-right font-medium">${texts.comparisonPeriod1}</th>
                        <th class="p-3 bg-slate-50 text-right font-medium">${texts.comparisonPeriod2}</th>
                        <th class="p-3 bg-slate-50 text-right font-medium text-blue-700">${texts.comparisonDifferenceRate}</th>
                    `;
                });
                headerHTML += '</tr></thead>';
                
                let bodyHTML = '<tbody>';
                
                // Accumulate totals
                let totalRowData = {};
                selectedMeasureHeaders.forEach(m => {
                    totalRowData[`${m}_p1`] = 0;
                    totalRowData[`${m}_p2`] = 0;
                });

                let sortedKeys = Array.from(allKeys);
                // Sorting Logic for Pivot
                if (sortState.column) {
                    sortedKeys.sort((keyA, keyB) => {
                        const rowA = { ...groupedP1[keyA], ...groupedP2[keyA], [groupByDimension]: keyA };
                        const rowB = { ...groupedP1[keyB], ...groupedP2[keyB], [groupByDimension]: keyB };
                        const valA = getSortValue(rowA, sortState.column);
                        const valB = getSortValue(rowB, sortState.column);

                        if (valA < valB) return sortState.direction === 'asc' ? -1 : 1;
                        if (valA > valB) return sortState.direction === 'asc' ? 1 : -1;
                        return 0;
                    });
                }
                sortedKeys.forEach(key => {
                    const p1 = groupedP1[key] || {};
                    const p2 = groupedP2[key] || {};

                    let rowHTML = `<tr class="border-b hover:bg-slate-50">`;
                    rowHTML += `<td class="p-3 text-left font-semibold sticky left-0 bg-white z-10">${key}</td>`;

                    selectedMeasureHeaders.forEach(m => {
                        const measureConfig = measureConfigs.find(cfg => cfg.name === m);
                        const format = measureConfig ? measureConfig.format : 'number';

                        const valP1 = p1[m] || 0;
                        const valP2 = p2[m] || 0;
                        
                        // Accumulate
                        totalRowData[`${m}_p1`] += valP1;
                        totalRowData[`${m}_p2`] += valP2;

                        let ratio = (valP2 !== 0) ? (valP1 / valP2) : (valP1 !== 0 ? Infinity : 0); // Use Infinity for display logic
                        
                        // Format
                        const formattedP1 = formatNumber(valP1, format);
                        const formattedP2 = formatNumber(valP2, format);
                        const formattedRatio = formatNumber(ratio, 'percent');
                        
                        // Apply color to difference rate
                        let diffClass = '';
                        if (ratio !== 1 && isFinite(ratio)) { // FIX: Use 'ratio' instead of 'diffRate' and check for finite numbers
                            const lowerIsBetterFlag = isLowerIsBetter(m);
                            // If ratio > 1, it's an increase. If < 1, it's a decrease.
                            const isIncrease = ratio > 1;
                            if ((isIncrease && !lowerIsBetterFlag) || (!isIncrease && lowerIsBetterFlag)) { // Good change
                                diffClass = 'text-green-700 font-bold'; 
                            } else { // Bad change
                                diffClass = 'text-red-700 font-bold'; 
                            }
                        }

                        rowHTML += `
                            <td class="p-3 text-right">${formattedP1}</td>
                            <td class="p-3 text-right">${formattedP2}</td>
                            <td class="p-3 text-right ${diffClass}">${formattedRatio}</td>
                        `;
                    });

                    rowHTML += '</tr>';
                    bodyHTML += rowHTML;
                });
                bodyHTML += '</tbody>';
                
                // --- Total Row Calculation and Rendering ---
                let footerHTML = '<tfoot>'; // Total Row
                let totalRowHTML = `<tr class="border-t-2 border-slate-300 font-bold bg-slate-100">`;
                totalRowHTML += `<td class="p-3 sticky left-0 bg-slate-100 z-10">${texts.tableTotal}</td>`;
                
                selectedMeasureHeaders.forEach(m => {
                    const measureConfig = measureConfigs.find(cfg => cfg.name === m);
                    const format = measureConfig ? measureConfig.format : 'number';
                    
                    const totalP1 = totalRowData[`${m}_p1`];
                    const totalP2 = totalRowData[`${m}_p2`];
                    let totalRatio = (totalP2 !== 0) ? (totalP1 / totalP2) : (totalP1 !== 0 ? Infinity : 0);

                    // Format
                    const formattedTotalP1 = formatNumber(totalP1, format);
                    const formattedTotalP2 = formatNumber(totalP2, format);
                    const formattedTotalRatio = formatNumber(totalRatio, 'percent');
                    
                    // Apply color to total difference rate
                    let diffClass = '';
                    if (totalRatio !== 1) {
                        const lowerIsBetterFlag = isLowerIsBetter(m);
                        const isIncrease = totalRatio > 1;
                        if ((isIncrease && !lowerIsBetterFlag) || (!isIncrease && lowerIsBetterFlag)) { // Good change
                            diffClass = 'text-green-700'; 
                        } else { // Bad change
                            diffClass = 'text-red-700'; 
                        }
                    }

                    totalRowHTML += `
                        <td class="p-3 text-right">${formattedTotalP1}</td>
                        <td class="p-3 text-right">${formattedTotalP2}</td>
                        <td class="p-3 text-right ${diffClass}">${formattedTotalRatio}</td>
                    `;
                });
                totalRowHTML += '</tr>';
                footerHTML += `${totalRowHTML}</tfoot>`;

                table.innerHTML = headerHTML + bodyHTML + footerHTML;
                tableContainer.appendChild(table);

                // Add Sort Listeners and Indicators
                table.querySelectorAll('.sortable-header').forEach(th => {
                    const columnId = th.dataset.columnId;
                    const indicator = th.querySelector('.sort-indicator');

                    if (sortState.column === columnId) {
                        th.classList.add('active');
                        indicator.innerHTML = sortState.direction === 'asc' ? '&#9650;' : '&#9660;';
                    }

                    th.addEventListener('click', () => {
                        if (window.isResizing) return; // FIX: Prevent sort when resizing
                        if (sortState.column === columnId) {
                            sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
                        } else {
                            sortState.column = columnId;
                            sortState.direction = 'asc';
                        }
                        renderComparisonTable();
                    });
                });
                makeColumnsResizable(table);

            } 
            
            // --- Flat View (Giống Image 2) ---
            else { // Flat View
                const table = document.createElement('table');
                table.id = 'comparison-table-flat';
                table.className = 'w-full text-sm text-left whitespace-nowrap';

                let headerHTML = '<thead><tr>';
                headerHTML += `<th class="p-3 bg-slate-50 text-left font-semibold sticky left-0 z-10 sortable-header cursor-pointer" data-column-id="${groupByDimension}">${groupByDimension}<span class="sort-indicator"></span></th>`;
                headerHTML += `<th class="p-3 bg-slate-50 text-left font-semibold">${texts.comparisonPeriod1} / ${texts.comparisonPeriod2}</th>`; // Period label column
                selectedMeasureHeaders.forEach(h => {
                    headerHTML += `<th class="p-3 bg-slate-50 text-right font-semibold sortable-header cursor-pointer" data-column-id="${h}">${h}<span class="sort-indicator"></span></th>`;
                });
                headerHTML += '</tr></thead>';

                let bodyHTML = '<tbody>'; // Total for Period 1
                let totalRowData = {};
                selectedMeasureHeaders.forEach(m => {
                    totalRowData[`${m}_p1`] = 0; // Total for Period 1
                    totalRowData[`${m}_p2`] = 0; // Total for Period 2 // Data for key in Period 1
                });
                
                Array.from(allKeys).sort().forEach(key => {
                    const p1 = groupedP1[key] || {}; // Data for key in Period 1
                    const p2 = groupedP2[key] || {}; // Row for Period 1
                    
                    // Row for Period 1
                    let rowP1 = `<tr class="border-b hover:bg-slate-50 border-green-200">`;
                    rowP1 += `<td class="p-3 text-left font-semibold sticky left-0 bg-white z-10">${key}</td>`;
                    rowP1 += `<td class="p-3 bg-green-50/50">${texts.comparisonPeriod1}</td>`;
                    selectedMeasureHeaders.forEach(m => {
                        const measureConfig = measureConfigs.find(cfg => cfg.name === m); // FIX: was cfg.format
                        const format = measureConfig ? measureConfig.format : 'number';
                        const val = p1[m] || 0;
                        totalRowData[`${m}_p1`] += val;
                        rowP1 += `<td class="p-3 text-right">${formatNumber(val, format)}</td>`;
                    });
                    rowP1 += '</tr>';
                    
                    // Row for Period 2
                    let rowP2 = `<tr class="border-b hover:bg-slate-50 border-emerald-200">`;
                    rowP2 += `<td class="p-3 text-left font-semibold sticky left-0 bg-white z-10"></td>`;
                    rowP2 += `<td class="p-3 bg-emerald-50/50">${texts.comparisonPeriod2}</td>`;
                    selectedMeasureHeaders.forEach(m => {
                        const measureConfig = measureConfigs.find(cfg => cfg.name === m); // FIX: was cfg.format
                        const format = measureConfig ? measureConfig.format : 'number';
                        const val = p2[m] || 0;
                        totalRowData[`${m}_p2`] += val;
                        rowP2 += `<td class="p-3 text-right">${formatNumber(val, format)}</td>`;
                    });
                    rowP2 += '</tr>';
                    
                    bodyHTML += rowP1 + rowP2;
                });
                bodyHTML += '</tbody>';
                
                // --- Total Row Calculation and Rendering (Flat View Total) ---
                let footerHTML = '<tfoot>'; // Total Row
                let totalRowHTML = `<tr class="border-t-2 border-slate-300 font-bold bg-slate-100">`;
                totalRowHTML += `<td class="p-3 sticky left-0 bg-slate-100 z-10">${texts.tableTotal}</td>`;
                totalRowHTML += `<td class="p-3">${texts.comparisonRatio}</td>`;

                selectedMeasureHeaders.forEach(m => {
                    const totalP1 = totalRowData[`${m}_p1`];
                    const totalP2 = totalRowData[`${m}_p2`];
                    let totalRatio = (totalP2 !== 0) ? (totalP1 / totalP2) : (totalP1 !== 0 ? Infinity : 0);

                    const measureConfig = measureConfigs.find(cfg => cfg.name === m); // FIX: was cfg.format
                    const format = measureConfig ? measureConfig.format : 'number';
                    
                    let diffClass = '';
                    if (totalRatio !== 1) {
                        const lowerIsBetterFlag = isLowerIsBetter(m);
                        const isIncrease = totalRatio > 1;
                        if ((isIncrease && !lowerIsBetterFlag) || (!isIncrease && lowerIsBetterFlag)) { // Good change
                            diffClass = 'text-green-700'; 
                        } else { // Bad change
                            diffClass = 'text-red-700'; 
                        }
                    }

                    totalRowHTML += `<td class="p-3 text-right">
                        <span class="font-bold text-sm text-slate-800">${formatNumber(totalP1, format)} / ${formatNumber(totalP2, format)}</span><br>
                        <span class="text-xs font-extrabold ${diffClass}">${formatNumber(totalRatio, 'percent')}</span>
                    </td>`;
                });
                totalRowHTML += '</tr>';
                footerHTML += `${totalRowHTML}</tfoot>`;

                table.innerHTML = headerHTML + bodyHTML + footerHTML;
                tableContainer.appendChild(table);

                // Add Sort Listeners and Indicators
                table.querySelectorAll('.sortable-header').forEach(th => {
                    const columnId = th.dataset.columnId;
                    const indicator = th.querySelector('.sort-indicator');

                    if (sortState.column === columnId) {
                        th.classList.add('active');
                        indicator.innerHTML = sortState.direction === 'asc' ? '&#9650;' : '&#9660;';
                    }

                    th.addEventListener('click', () => {
                        if (window.isResizing) return; // FIX: Prevent sort when resizing
                        if (sortState.column === columnId) {
                            sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
                        } else {
                            sortState.column = columnId;
                            sortState.direction = 'asc';
                        }
                        renderComparisonTable();
                    });
                });
                makeColumnsResizable(table);
            }
        }
        
        // --- CUSTOM REPORT PAGE ---
        
        // --- Column Resizing Function ---
        function makeColumnsResizable(table) {
            const headers = table.querySelectorAll('th');
            headers.forEach((header, index) => {
                // Don't add handle to the last column
                // Note: The logic for the Comparison table is more complex with colspan, 
                // but for simplicity, we keep the handle on all non-last TH elements.
                // The fixed width for the leftmost sticky column is handled by CSS/class.
                if (index === headers.length - 1) {
                    return; // Don't add handle to the last column
                }
                
                // Remove existing handle if any to prevent duplicates
                header.querySelector('.resize-handle')?.remove();

                const resizeHandle = document.createElement('div');
                resizeHandle.className = 'resize-handle';
                header.appendChild(resizeHandle);
                
                header.style.position = 'relative'; // Ensure parent is positioned

                resizeHandle.addEventListener('mousedown', (e) => { // Prevent click event on TH from firing for sorting 
                    e.stopPropagation(); // Prevent click event on TH from firing for sorting 
                    onMouseDown(e, header);
                });
            });

            let th;
            let startX, startWidth;

            function onMouseDown(e, header) {
                window.isResizing = true; // Set the flag
                e.preventDefault(); // Prevent text selection
                e.stopPropagation(); // Stop any other events 
                
                th = header;
                startX = e.pageX;
                startWidth = th.offsetWidth;

                document.body.classList.add('resizing'); // Add class to body for global cursor change
                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            }

            function onMouseMove(e) {
                if (!th) return;
                const dx = e.pageX - startX;
                const newWidth = startWidth + dx;
                
                // Set a minimum width
                if (newWidth > 50) { 
                    th.style.width = `${newWidth}px`;
                }
            }

            function onMouseUp() {
                document.body.classList.remove('resizing');
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
                // Use a timeout to reset the flag, allowing the click event to be fully suppressed
                setTimeout(() => { // Use a timeout to reset the flag, allowing the click event to be fully suppressed
                    window.isResizing = false;
                }, 100);
                th = null; // Clear reference
            }
        }

        function renderCustomReportPage(container) {
             // Re-use the existing custom-page HTML structure
            container.innerHTML = `
                <div class="p-1 bg-gradient-to-r from-green-500 to-emerald-500 rounded-xl shadow-lg mb-6">
                    <div class="bg-white p-6 rounded-lg">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold" data-i18n="navCustom">カスタムレポート</h2>
                            <button id="customize-report-btn" class="interactive-button px-4 py-2 font-semibold rounded-lg bg-white text-slate-700 border border-slate-300 hover:bg-slate-50 flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><polygon points="14 2 18 6 7 17 3 17 3 13 14 2"></polygon><line x1="3" y1="22" x2="21" y2="22"></line></svg>
                                <span data-i18n="customReportCustomize">表示項目を編集</span>
                            </button>
                        </div>
                        <div id="custom-report-table-container" class="overflow-x-auto">
                            </div>
                    </div>
                </div>

                <div class="p-1 bg-gradient-to-r from-green-500 to-emerald-500 rounded-xl shadow-lg">
                    <div class="bg-white p-6 rounded-lg">
                         <h2 class="text-xl font-bold mb-4" data-i18n="customChartTitle">カスタムグラフ</h2>
                         <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4 items-end">
                            <div>
                                <label for="custom-chart-dimension" class="font-semibold text-sm mb-1 block" data-i18n="customChartDimension">軸:</label>
                                <select id="custom-chart-dimension" class="custom-select w-full bg-white border border-slate-300 text-slate-700 text-sm rounded-lg focus:ring-green-500 focus:border-green-500 block px-3 py-2"></select>
                            </div>
                            <div>
                                <label for="custom-chart-measure1" class="font-semibold text-sm mb-1 block" data-i18n="customChartMeasure1">指標1:</label>
                                <select id="custom-chart-measure1" class="custom-select w-full bg-white border border-slate-300 text-slate-700 text-sm rounded-lg focus:ring-green-500 focus:border-green-500 block px-3 py-2"></select>
                            </div>
                            <div>
                                <label for="custom-chart-measure2" class="font-semibold text-sm mb-1 block" data-i18n="customChartMeasure2">指標2:</label>
                                <select id="custom-chart-measure2" class="custom-select w-full bg-white border border-slate-300 text-slate-700 text-sm rounded-lg focus:ring-green-500 focus:border-green-500 block px-3 py-2">
                                    <option value="">(なし)</option> 
                                </select>
                            </div>
                             <div>
                                <label for="custom-chart-type" class="font-semibold text-sm mb-1 block" data-i18n="customChartType">グラフ種:</label>
                                <select id="custom-chart-type" class="custom-select w-full bg-white border border-slate-300 text-slate-700 text-sm rounded-lg focus:ring-green-500 focus:border-green-500 block px-3 py-2">
                                    <option value="bar" data-i18n="customChartTypeBar">棒グラフ</option>
                                    <option value="line" data-i18n="customChartTypeLine">折れ線グラフ</option>
                                    <option value="pie" data-i18n="customChartTypePie">円グラフ</option>
                                </select>
                            </div>
                         </div>
                         <div id="custom-chart-container" class="relative h-96">
                            <canvas id="custom-chart-canvas"></canvas>
                            <div id="custom-chart-target-toggle-container" class="absolute top-4 right-4 bg-white p-2 rounded-lg shadow hidden items-center gap-2">
                                <label for="custom-chart-target-toggle" class="text-sm font-medium">Target Line</label>
                                <label class="flex items-center cursor-pointer">
                                    <div class="relative">
                                        <input type="checkbox" id="custom-chart-target-toggle" class="sr-only toggle-input">
                                        <div class="block bg-slate-200 w-10 h-6 rounded-full toggle-bg"></div>
                                        <div class="dot absolute left-0.5 top-0.5 bg-white w-5 h-5 rounded-full transition-transform"></div>
                                    </div>
                                </label>
                            </div>
                         </div>
                    </div>
                </div>
            `;
            
            // Add event listener for the table customize button
            container.querySelector('#customize-report-btn').addEventListener('click', openCustomReportModal);
            
            // Render the table with the current custom config
            renderCustomTable(); // Populate chart selectors and add listeners

            // Populate chart selectors and add listeners
            const dimSelect = document.getElementById('custom-chart-dimension');
            const measure1Select = document.getElementById('custom-chart-measure1');
            const measure2Select = document.getElementById('custom-chart-measure2');
            const typeSelect = document.getElementById('custom-chart-type');
            // NEW: Target toggle element
            const targetToggle = document.getElementById('custom-chart-target-toggle');

            dimSelect.innerHTML = '';
             // Add 'Date' as the first dimension option
             dimSelect.innerHTML += `<option value="date">${uiTexts[currentLanguage].dailyDateHeader || 'Date'}</option>`;
            templateConfig.dimensions.filter(d => d).forEach(dim => { // Filter null/empty dimensions
                 // Avoid adding date again if it's already in template dimensions
                 if (dim.toLowerCase() !== 'date') {
                     dimSelect.innerHTML += `<option value="${dim}">${dim}</option>`;
                 }
            });

            measure1Select.innerHTML = '';
            measure2Select.innerHTML = '<option value="">(なし)</option>';
            templateConfig.measures.forEach(m => {
                measure1Select.innerHTML += `<option value="${m.name}">${m.name}</option>`;
                measure2Select.innerHTML += `<option value="${m.name}">${m.name}</option>`;
            });

            // Set default selections (e.g., first dimension and first measure)
            dimSelect.value = customReportConfig.dimensions.includes('date') ? 'date' : templateConfig.dimensions[0] || 'date'; // Default to first dimension or date
            measure1Select.value = customReportConfig.measures[0] || templateConfig.measures[0]?.name || '';

            // Re-render chart on change
            [dimSelect, measure1Select, measure2Select, typeSelect].forEach(select => {
                if(select) { // Ensure select exists before adding listener
                    select.addEventListener('change', renderCustomChart);
                }
            });
            
            // Add listener for target toggle
            if(targetToggle) targetToggle.addEventListener('change', renderCustomChart);


            // Initial render
            renderCustomChart();
        }
        
        // --- Render Custom Chart ---
        function renderCustomChart() {
            const texts = uiTexts[currentLanguage];
            const canvas = document.getElementById('custom-chart-canvas');
            const container = document.getElementById('custom-chart-container');
            if (!canvas || !container) return; // Exit if elements not found

            const dimension = document.getElementById('custom-chart-dimension')?.value;
            const measure1 = document.getElementById('custom-chart-measure1')?.value;
            const measure2 = document.getElementById('custom-chart-measure2')?.value;
            const chartType = document.getElementById('custom-chart-type')?.value;
            const targetToggle = document.getElementById('custom-chart-target-toggle');
            
            const measureConfigs = templateConfig.measures;


            // Clear previous chart
            if (customChartInstance) {
                customChartInstance.destroy();
                customChartInstance = null;
            }
            container.querySelector('.chart-error-message')?.remove();

            if (!dimension) {
                 container.insertAdjacentHTML('beforeend', `<p class="chart-error-message text-center text-red-600 font-semibold p-4" data-i18n="customChartNoDimension">${texts.customChartNoDimension}</p>`);
                return;
            }
             if (!measure1) {
                 container.insertAdjacentHTML('beforeend', `<p class="chart-error-message text-center text-red-600 font-semibold p-4" data-i18n="customChartNoMeasure">${texts.customChartNoMeasure}</p>`);
                return; // Toggle Target Line visibility based on measure and chart type
            }
            
            // --- NEW: Toggle Target Line visibility based on measure and chart type ---
            const targetToggleContainer = document.getElementById('custom-chart-target-toggle-container');
            const isTargetMeasure1 = measure1 === globalTarget.measureName && globalTarget.value !== null && globalTarget.value > 0;
            const isTargetMeasure2 = measure2 === globalTarget.measureName && globalTarget.value !== null && globalTarget.value > 0;
            const canShowTargetLine = (isTargetMeasure1 || isTargetMeasure2) && chartType !== 'pie';

            if (canShowTargetLine) {
                 targetToggleContainer.classList.remove('hidden');
                 targetToggleContainer.classList.add('flex');
            } else {
                 targetToggleContainer.classList.add('hidden');
                 targetToggleContainer.classList.remove('flex');
                 if(targetToggle) targetToggle.checked = false; // Reset toggle if not applicable
            } // Reset toggle if not applicable
            const showTargetLine = targetToggle?.checked && canShowTargetLine;


            const groupedData = groupAndCalculateData(filteredData, dimension);

            let labels = Object.keys(groupedData);
            // Sort labels if the dimension is 'date'
             if (dimension === 'date') {
                 labels.sort((a, b) => new Date(a) - new Date(b));
             }

            const datasets = [];

            // Get measure formats for tooltips
            const format1 = measureConfigs.find(m => m.name === measure1)?.format || 'number';
            const format2 = measureConfigs.find(m => m.name === measure2)?.format || 'number';

            // Prepare datasets using sorted labels
            const data1 = labels.map(label => groupedData[label][measure1] || 0);
            datasets.push({
                label: measure1,
                data: data1,
                backgroundColor: chartType === 'pie' ? CHART_COLORS_PASTEL : CHART_COLORS_PASTEL[0], // Use multiple colors for pie
                borderColor: CHART_COLORS_PASTEL[0],
                yAxisID: 'y',
                tension: 0.1
            });

            let scales = { 
                x: { 
                    // Set x-axis type to 'time' if dimension is 'date'
                    type: dimension === 'date' ? 'time' : 'category',
                    time: dimension === 'date' ? { 
                        unit: 'day',
                        displayFormats: { day: 'yy/MM/dd' },
                        tooltipFormat: 'yy/MM/dd'
                    } : undefined, 
                }, 
                y: { 
                    position: 'left',
                    ticks: {
                        callback: (value) => formatNumber(value, format1)
                    }
                } 
            }; 

            if (measure2 && chartType !== 'pie') {
                 const data2 = labels.map(label => groupedData[label][measure2] || 0);
                datasets.push({
                    label: measure2,
                    data: data2,
                    backgroundColor: '#67AE6E',
                    borderColor: '#67AE6E',
                    yAxisID: 'y1',
                    tension: 0.1
                });
                // Add second y-axis
                scales.y1 = { 
                    position: 'right', 
                    grid: { drawOnChartArea: false },
                    ticks: {
                         callback: (value) => formatNumber(value, format2)
                    }
                };
            }
            
             // Pie chart specific adjustments
            if (chartType === 'pie') { // No axes for pie chart
                scales = {}; // No axes for pie chart
                 // For pie charts, data needs to be an array of numbers, labels are separate
                 datasets[0].data = data1; // Ensure data1 is used
                 datasets[0].backgroundColor = CHART_COLORS_PASTEL; // Use all colors for slices
                 if (datasets.length > 1) datasets.pop(); // Pie only uses first measure
            } else if (dimension === 'date') { // For time series, data needs {x: date, y: value} format
                 // For time series line/bar, data needs {x: date, y: value} format
                 datasets[0].data = labels.map(label => ({ x: label, y: groupedData[label][measure1] || 0 }));
                 if (datasets.length > 1) {
                     datasets[1].data = labels.map(label => ({ x: label, y: groupedData[label][measure2] || 0 }));
                 }
            }
            
            // Add Target Line Dataset (for line/bar charts if enabled)
            if (showTargetLine) {
                 const targetMeasure = globalTarget.measureName;
                 const targetValue = globalTarget.value;
                 const targetData = labels.map(label => {
                     if (dimension === 'date') {
                         return { x: label, y: targetValue };
                     } else {
                         return targetValue;
                     }
                 });
                 
                 // Determine which y-axis the target measure belongs to (y or y1)
                 let targetYAxisID = 'y'; // Determine which y-axis the target measure belongs to
                 if (targetMeasure === measure2 && measure2) {
                     targetYAxisID = 'y1';
                 }

                 datasets.push({
                     label: `${targetMeasure} Target`,
                     data: targetData,
                     borderColor: '#ef4444', // Red for Target
                     borderWidth: 2, // Red for Target
                     borderDash: [5, 5],
                     fill: false,
                     type: 'line', // Always a line regardless of chartType
                     yAxisID: targetYAxisID,
                     pointRadius: 0,
                     tension: 0 // Straight line
                 });
            }


            const ctx = canvas.getContext('2d');
            customChartInstance = new Chart(ctx, { // Labels remain separate for time axis config
                type: chartType,
                data: {
                    labels: labels, 
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: scales,
                    plugins: { // Show legend for non-pie or pie with few slices
                        legend: {
                            display: chartType !== 'pie' || labels.length <= 10 
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    const value = context.parsed.y !== undefined ? context.parsed.y : context.parsed;
                                    const format = context.dataset.yAxisID === 'y' ? format1 : format2;
                                    
                                    // Handle tooltip for target line
                                    if(context.dataset.type === 'line' && context.dataset.label.includes('Target')) {
                                         label += formatNumber(value, format1); // Use format1 as default for target if unsure
                                    } else {
                                         label += formatNumber(value, format);
                                    }
                                    
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }


        function renderCustomTable() {
            const tableContainer = document.getElementById('custom-report-table-container');
            if (!tableContainer) return;
            
            const texts = uiTexts[currentLanguage];
            const { dimensions, measures } = customReportConfig;
            const allHeaders = [...dimensions, ...measures];

            if (allHeaders.length === 0) {
                tableContainer.innerHTML = `<p class="text-slate-500 text-center py-8" data-i18n="customTableEmpty">${texts.customTableEmpty}</p>`; // Get all measure configs from template for formatting and calculation
                return;
            }

            const table = document.createElement('table');
            table.id = 'custom-report-table';
            table.className = 'w-full text-sm text-left whitespace-nowrap';

            // Get all measure configs from template
            const allMeasureConfigs = templateConfig.measures;
            const measureHeaders = allMeasureConfigs.map(m => m.name);
            
            let headerHTML = '<tr>';
            allHeaders.forEach(h => {
                const isMeasure = measures.includes(h);
                const alignClass = isMeasure ? 'text-right' : 'text-left';
                const dataI18n = (h === 'date') ? ` data-i18n="dailyDateHeader"` : '';
                
                 let colName = h;
                 if (globalTarget.measureName === h && globalTarget.value !== null) {
                    colName = `${h} / ${uiTexts[currentLanguage].headerTargetMeasureLabel}`; 
                 }
                 const sortableClass = 'sortable-header cursor-pointer';
                 headerHTML += `<th class="p-3 bg-slate-50 ${alignClass} font-semibold ${sortableClass}" data-column-id="${h}" ${dataI18n}>${colName}<span class="sort-indicator"></span></th>`;
            });
            headerHTML += '</tr>';

            const groupedData = groupAndCalculateData(filteredData, dimensions.join('||'));

            let tableBodyHTML = '';
                // --- FIX: Sorting Logic ---
                let dataToRender = Object.values(groupedData);

                // Áp dụng logic sắp xếp dựa trên sortState
                if (sortState.column && allHeaders.includes(sortState.column)) {
                    dataToRender.sort((a, b) => {
                        const valA = getSortValue(a, sortState.column);
                        const valB = getSortValue(b, sortState.column);

                        if (valA < valB) return sortState.direction === 'asc' ? -1 : 1;
                        if (valA > valB) return sortState.direction === 'asc' ? 1 : -1;
                        return 0;
                    });
                }

            dataToRender.forEach(group => { 
                let rowHTML = '<tr class="border-b hover:bg-slate-50">';
                allHeaders.forEach(header => {
                    const value = group[header];
                    const isMeasure = measures.includes(header);
                    const measureConfig = isMeasure ? allMeasureConfigs.find(m => m.name === header) : null;
                    const format = measureConfig ? measureConfig.format : 'number';
                    const alignClass = isMeasure ? 'text-right' : 'text-left';
                    let cellContent;

                    if (isMeasure) { // Target comparison for Custom Table
                         // --- NEW: Target comparison for Custom Table ---
                        if (header === globalTarget.measureName && globalTarget.value !== null && globalTarget.value > 0) {
                            const target = globalTarget.value;
                            const percentageRatio = (value / target) * 100; 
                            const lowerIsBetterFlag = isLowerIsBetter(header);

                            let indicatorClass;

                            if (lowerIsBetterFlag) {
                                if (percentageRatio <= 100) {
                                    indicatorClass = 'text-green-600 bg-green-100';
                                } else if (percentageRatio <= 125) {
                                    indicatorClass = 'text-yellow-700 bg-yellow-100';
                                } else {
                                    indicatorClass = 'text-red-600 bg-red-100';
                                }
                            } else {
                                if (percentageRatio >= 100) {
                                    indicatorClass = 'text-green-600 bg-green-100';
                                } else if (percentageRatio >= 75) {
                                    indicatorClass = 'text-yellow-700 bg-yellow-100';
                                } else {
                                    indicatorClass = 'text-red-600 bg-red-100';
                                }
                            }

                            cellContent = `
                                <div class="flex flex-col items-end">
                                    <span class="font-semibold">${formatNumber(value, format)}</span>
                                    <span class="text-xs font-medium ${indicatorClass} rounded-full px-2 mt-0.5">${percentageRatio.toFixed(1)}%</span>
                                </div>
                            `;
                        } else {
                            cellContent = formatNumber(value, format);
                        }
                        rowHTML += `<td class="p-3 ${alignClass}">${cellContent}</td>`;
                    } else {
                        rowHTML += `<td class="p-3 text-left">${value || ''}</td>`;
                    }
                });
                rowHTML += '</tr>';
                tableBodyHTML += rowHTML;
            });

            // Calculate totals for the footer
            const totals = calculateTotals(filteredData);

            let totalRowHTML = `<tr class="border-t-2 border-slate-300 font-bold bg-slate-100">`;
            let firstCol = true;
            allHeaders.forEach(header => {
                if (dimensions.includes(header)) {
                    if (firstCol) {
                        totalRowHTML += `<td class="p-3">${texts.tableTotal}</td>`;
                        firstCol = false;
                    } else {
                         totalRowHTML += `<td class="p-3"></td>`;
                    }
                } else if (measures.includes(header)) {
                    const measureConfig = allMeasureConfigs.find(m => m.name === header); // Target comparison for Custom Table Total Row
                    const format = measureConfig ? measureConfig.format : 'number';
                    
                    let totalContent = formatNumber(totals[header], format);
                    // --- NEW: Target comparison for Custom Table Total Row ---
                    if (header === globalTarget.measureName && globalTarget.value !== null && globalTarget.value > 0) {
                        const target = globalTarget.value;
                        const percentageRatio = (totals[header] / target) * 100;
                        const lowerIsBetterFlag = isLowerIsBetter(header);

                        let indicatorClass;
                        
                        if (lowerIsBetterFlag) {
                            if (percentageRatio <= 100) {
                                indicatorClass = 'text-green-600 bg-green-100';
                            } else if (percentageRatio <= 125) {
                                indicatorClass = 'text-yellow-700 bg-yellow-100';
                            } else {
                                indicatorClass = 'text-red-600 bg-red-100';
                            }
                        } else {
                            if (percentageRatio >= 100) {
                                indicatorClass = 'text-green-600 bg-green-100';
                            } else if (percentageRatio >= 75) {
                                indicatorClass = 'text-yellow-700 bg-yellow-100';
                            } else {
                                indicatorClass = 'text-red-600 bg-red-100';
                            }
                        }
                        
                        totalContent = `
                            <div class="flex flex-col items-end">
                                <span class="font-bold">${formatNumber(totals[header], format)}</span>
                                <span class="text-xs font-extrabold ${indicatorClass} rounded-full px-2 mt-0.5">${percentageRatio.toFixed(1)}%</span>
                            </div>
                        `;
                    }
                    
                    totalRowHTML += `<td class="p-3 text-right">${totalContent}</td>`;
                } else {
                    totalRowHTML += `<td class="p-3"></td>`; 
                }
            });
            totalRowHTML += '</tr>';
            
            table.innerHTML = `
                <thead class="sticky top-0">${headerHTML}</thead>
                <tbody>${tableBodyHTML}</tbody>
                <tfoot>${totalRowHTML}</tfoot>
            `;
            tableContainer.innerHTML = ''; 
            tableContainer.appendChild(table);

            // Add Sort Listeners and Indicators
            table.querySelectorAll('.sortable-header').forEach(th => {
                const columnId = th.dataset.columnId;
                const indicator = th.querySelector('.sort-indicator');

                if (sortState.column === columnId) {
                    th.classList.add('active');
                    indicator.innerHTML = sortState.direction === 'asc' ? '&#9650;' : '&#9660;'; // Up/Down arrow
                }

                th.addEventListener('click', () => {
                    if (window.isResizing) return; // FIX: Prevent sort when resizing
                    if (sortState.column === columnId) {
                        sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        sortState.column = columnId;
                        sortState.direction = 'asc';
                    }
                    renderCustomTable(); // Re-render the table
                });
            });

             // --- Apply resizable functionality ---
            makeColumnsResizable(table); // Translate Date header after render

            const dateHeader = table.querySelector('th[data-i18n="dailyDateHeader"]');
            if (dateHeader) {
                dateHeader.textContent = texts.dailyDateHeader || 'Date';
            }
        }

        function openCustomReportModal() {
            const texts = uiTexts[currentLanguage];
            const { dimensions: selectedDims, measures: selectedMeasures } = customReportConfig;
            const selectedSet = new Set([...selectedDims, ...selectedMeasures]);

            let availableHTML = '';
            let selectedHTML = ''; // Add 'Date' as an available dimension

            // --- Add 'Date' as an available dimension ---
            const dateColName = texts.dailyDateHeader || 'Date';
            const dateItemHTML = `<div class="draggable-item" data-column-id="date" data-type="dimension">${dateColName}</div>`;
             if (!selectedSet.has('date')) {
                 availableHTML += dateItemHTML;
             }

            // Add other template dimensions
            templateConfig.dimensions.filter(d => d).forEach(dim => { // Filter null/empty dimensions
                 // Avoid adding date again if it's already in template dimensions
                 if (dim.toLowerCase() !== 'date') { 
                    const itemHTML = `<div class="draggable-item" data-column-id="${dim}" data-type="dimension">${dim}</div>`;
                    if (!selectedSet.has(dim)) {
                        availableHTML += itemHTML;
                    }
                 }
            });
            
            // Add all measures
            templateConfig.measures.forEach(measure => {
                const itemHTML = `<div class="draggable-item" data-column-id="${measure.name}" data-type="measure">${measure.name}</div>`;
                if (!selectedSet.has(measure.name)) {
                    availableHTML += itemHTML;
                }
            });

            // Add selected columns in their saved order
            [...selectedDims, ...selectedMeasures].forEach(colName => { // Check if it's the special 'date' column or a template dimension/measure
                 // Check if it's the special 'date' column or a template dimension/measure
                 const isDate = colName === 'date';
                 const isTemplateDimension = templateConfig.dimensions.includes(colName);
                 const type = (isDate || isTemplateDimension) ? 'dimension' : 'measure';
                 const displayName = isDate ? dateColName : colName; // Use translated name for Date
                 
                 // Only render if the column exists in the data/template
                 if (isDate || isTemplateDimension || templateConfig.measures.some(m => m.name === colName)) {
                     selectedHTML += `<div class="draggable-item" data-column-id="${colName}" data-type="${type}">${displayName}</div>`;
                 }
            });

            el.availableColumnsListCustom.innerHTML = availableHTML;
            el.selectedColumnsDropzoneCustom.innerHTML = selectedHTML;

            // Initialize SortableJS
            if (sortableAvailable) sortableAvailable.destroy();
            if (sortableSelected) sortableSelected.destroy();

            sortableAvailable = new Sortable(el.availableColumnsListCustom, {
                group: { name: 'custom-columns', put: true },
                animation: 150,
                ghostClass: 'sortable-ghost'
            });
            
            sortableSelected = new Sortable(el.selectedColumnsDropzoneCustom, {
                group: { name: 'custom-columns', put: true },
                animation: 150,
                ghostClass: 'sortable-ghost'
            });

            translateElements(el.customReportModal);
            el.customReportModal.classList.remove('hidden');
            el.customReportModal.classList.add('flex');
        }

        function closeCustomReportModal() {
            el.customReportModal.classList.add('hidden');
            el.customReportModal.classList.remove('flex');
        }

        function applyCustomReportChanges() {
            const selectedItems = Array.from(el.selectedColumnsDropzoneCustom.children);
            
            const newConfig = {
                dimensions: [],
                measures: []
            };

            selectedItems.forEach(item => {
                const colId = item.dataset.columnId;
                const type = item.dataset.type;
                if (type === 'dimension') {
                    newConfig.dimensions.push(colId);
                } else if (type === 'measure') {
                    newConfig.measures.push(colId);
                }
            });

            customReportConfig = newConfig;
            sortState = { column: null, direction: 'asc' }; // Reset sort on column change
            renderCustomTable();
            // Re-render chart to update dimension/measure options
            renderCustomChart(); 
            closeCustomReportModal();
        }
        
        function openComparisonCustomizeModal() {
            const texts = uiTexts[currentLanguage];
            const { dimensions: selectedDims, measures: selectedMeasures } = comparisonReportConfig;
            const selectedSet = new Set([...selectedDims, ...selectedMeasures]);

            let availableHTML = ''; // Dimension List
            let selectedHTML = '';
            
            // Dimension List
            const allDimensions = ['date', ...templateConfig.dimensions.filter(d => d.toLowerCase() !== 'date')];
            allDimensions.forEach(dim => {
                const displayName = dim === 'date' ? texts.dailyDateHeader : dim;
                const itemHTML = `<div class="draggable-item" data-column-id="${dim}" data-type="dimension">${displayName}</div>`;
                if (!selectedSet.has(dim)) {
                    availableHTML += itemHTML;
                }
            });

            // Measure List // Selected columns in order
            templateConfig.measures.forEach(measure => {
                const itemHTML = `<div class="draggable-item" data-column-id="${measure.name}" data-type="measure">${measure.name}</div>`;
                if (!selectedSet.has(measure.name)) {
                    availableHTML += itemHTML;
                }
            });

            // Selected columns
            [...selectedDims, ...selectedMeasures].forEach(colName => {
                const isDate = colName === 'date';
                const isTemplateDimension = templateConfig.dimensions.includes(colName);
                const type = (isDate || isTemplateDimension) ? 'dimension' : 'measure';
                const displayName = isDate ? texts.dailyDateHeader : colName; 
                
                if (isDate || isTemplateDimension || templateConfig.measures.some(m => m.name === colName)) {
                    selectedHTML += `<div class="draggable-item" data-column-id="${colName}" data-type="${type}">${displayName}</div>`;
                }
            });

            el.availableColumnsListComparison.innerHTML = availableHTML;
            el.selectedColumnsDropzoneComparison.innerHTML = selectedHTML; // Init SortableJS for Comparison Modal

            // Init SortableJS for Comparison Modal
            if (sortableAvailableComparison) sortableAvailableComparison.destroy();
            if (sortableSelectedComparison) sortableSelectedComparison.destroy();

            sortableAvailableComparison = new Sortable(el.availableColumnsListComparison, {
                group: { name: 'comparison-columns', put: true },
                animation: 150,
                ghostClass: 'sortable-ghost'
            });
            
            // Logic to limit to only 1 dimension in the "Selected" column
            sortableSelectedComparison = new Sortable(el.selectedColumnsDropzoneComparison, {
                group: { name: 'comparison-columns', put: true },
                animation: 150,
                ghostClass: 'sortable-ghost',
                onAdd: function (evt) {
                    const isDimension = evt.item.dataset.type === 'dimension';
                    if (isDimension) {
                        const existingDims = Array.from(el.selectedColumnsDropzoneComparison.children).filter(item => item.dataset.type === 'dimension');
                        if (existingDims.length > 1) {
                            alert(texts.comparisonDimensionLimit || 'Only one dimension can be selected for comparison reports.');
                            evt.item.remove(); // Remove item if limit is exceeded
                            sortableAvailableComparison.sort(sortableAvailableComparison.toArray()); // Re-add to available list
                        }
                    }
                },
                // Allow reordering, but handle cases where a Dimension is moved to an invalid position.
                onMove: function(evt) {
                    // Simplest approach: allow drag-and-drop, then fix the order in the apply function.
                    return true;
                }
            });
            
            translateElements(el.comparisonCustomizeModal);
            el.comparisonCustomizeModal.classList.remove('hidden');
            el.comparisonCustomizeModal.classList.add('flex');
        }

        function applyComparisonCustomizeChanges() {
            const selectedItems = Array.from(el.selectedColumnsDropzoneComparison.children);
            
            const newConfig = {
                dimensions: [],
                measures: []
            };

            selectedItems.forEach(item => {
                const colId = item.dataset.columnId;
                const type = item.dataset.type;
                if (type === 'dimension') {
                    newConfig.dimensions.push(colId);
                } else if (type === 'measure') {
                    newConfig.measures.push(colId);
                }
            });
            
            if (newConfig.dimensions.length !== 1 || newConfig.measures.length === 0) { // Enforce exactly one dimension
                alert('Please select exactly one dimension and at least one measure.');
                return;
            }

            // Ensure only one dimension is set as the groupByDimension
            newConfig.dimensions = [newConfig.dimensions[0]]; 

            comparisonReportConfig = newConfig;
            sortState = { column: null, direction: 'asc' }; // Reset sort on column change
            
            // Update the comparison state directly
            // Update the state directly. The dropdown element was removed.
            comparisonState.groupByDimension = newConfig.dimensions[0] || null;
            
            // Re-render the table to apply changes
            renderComparisonTable(); 

            // --- FIX: Close modal after applying changes ---
            closeComparisonCustomizeModal();
        }

        function initEventListeners() {
            el.navMenu.addEventListener('click', (e) => {
                const link = e.target.closest('.nav-link');
                if (link && !link.classList.contains('pointer-events-none')) {
                    e.preventDefault(); // Reset sort on page change
                    sortState = { column: null, direction: 'asc' }; // Reset sort on page change
                    showPage(link.dataset.page);
                }
            });

            el.selectFilesBtn.addEventListener('click', () => el.csvFilesInput.click());
            el.csvFilesInput.addEventListener('change', handleFileSelection);
            
            el.loadTemplatesBtn.addEventListener('click', () => el.templateFilesInput.click());
            el.templateFilesInput.addEventListener('change', handleTemplateFileSelection);
            
            el.templateList.addEventListener('click', (e) => {
                const templateItem = e.target.closest('.template-item');
                if (!templateItem) return;

                if (e.target.closest('.view-template-btn')) {
                    e.stopPropagation();
                    const fileName = e.target.closest('.view-template-btn').dataset.templateName;
                    const template = loadedTemplates.find(t => t.fileName === fileName);
                    if (template) showTemplateDetails(template);
                    return;
                }
                
                document.querySelectorAll('.template-item').forEach(i => i.classList.remove('ring-2', 'ring-green-500', 'bg-green-50'));
                templateItem.classList.add('ring-2', 'ring-green-500', 'bg-green-50');
                
                const fileName = templateItem.dataset.templateName;
                const selectedTemplate = loadedTemplates.find(t => t.fileName === fileName);
                templateConfig = selectedTemplate;
                console.log("Template selected:", templateConfig);
                updateHomeButtonStates();
            });

            el.createTemplateBtn.addEventListener('click', openCreateTemplateModal);
            el.saveTemplateBtn.addEventListener('click', saveTemplate);
            el.cancelCreateTemplateBtn.addEventListener('click', closeCreateTemplateModal);
            el.closeSidePeekBtn.addEventListener('click', () => el.templateSidePeek.classList.remove('open'));
            el.closeCsvPeekBtn.addEventListener('click', () => el.csvFilesSidePeek.style.transform = 'translateX(100%)');
            el.startAnalysisBtn.addEventListener('click', startAnalysis);
            el.manageFilesBtn.addEventListener('click', () => {
                renderFileLists();
                el.csvFilesSidePeek.style.transform = 'translateX(0%)';
            });
            el.addCalculatedFieldBtn.addEventListener('click', openCalculatedFieldModal);
            el.cancelCalculatedFieldBtn.addEventListener('click', closeCalculatedFieldModal);
            el.saveCalculatedFieldBtn.addEventListener('click', saveCalculatedField);
            
            el.openFilterModalBtn.addEventListener('click', () => {
                translateElements(el.filterModal); 
                el.filterModal.classList.add('flex');
                el.filterModal.classList.remove('hidden');
            });
            el.closeFilterModalBtn.addEventListener('click', () => {
                el.filterModal.classList.add('hidden');
                el.filterModal.classList.remove('flex');
            });
            
            el.applyFiltersBtn.addEventListener('click', applyGlobalFilters);
            el.resetFiltersBtn.addEventListener('click', resetGlobalFilters);
            
            const addNewFilterBtn = document.getElementById('add-new-filter-btn'); // Add filter button listener
            if (addNewFilterBtn) {
                 addNewFilterBtn.addEventListener('click', addDimensionFilter);
            }
            
            el.languageToggle.addEventListener('change', (e) => {
                currentLanguage = e.target.checked ? 'en' : 'ja';
                updateUIForLanguage(); 
            });
            
            el.currencyToggleBtn.addEventListener('click', (e) => {
                currentCurrency = (currentCurrency === 'JPY') ? 'USD' : 'JPY';
                e.currentTarget.textContent = (currentCurrency === 'JPY') ? '¥' : '$';
                e.currentTarget.dataset.currency = currentCurrency; // Re-render page to reflect currency changes
                
                const activePage = document.querySelector('.app-page:not(.hidden)');
                if (activePage && activePage.id !== 'home-page') {
                    renderDashboardPage(activePage.id);
                }
            });

            // Add event listeners for new Custom Report Modal
             if (el.applyCustomReportBtn) { // Target setting listeners
                 el.applyCustomReportBtn.addEventListener('click', applyCustomReportChanges);
            }
             if (el.cancelCustomReportBtn) {
                el.cancelCustomReportBtn.addEventListener('click', closeCustomReportModal);
            }
            
            // --- NEW: Target setting listeners ---
            if (el.targetMeasureSelect) { // Comparison Customize Modal Listeners
                 el.targetMeasureSelect.addEventListener('change', handleTargetChange);
            }
            if (el.targetValueInput) {
                 el.targetValueInput.addEventListener('change', handleTargetChange);
            }

            // --- NEW: Comparison Customize Modal Listeners ---
            if (el.applyComparisonCustomizeBtn) { // Comparison Customize Modal Listeners
                 el.applyComparisonCustomizeBtn.addEventListener('click', applyComparisonCustomizeChanges);
            }
            if (el.cancelComparisonCustomizeBtn) {
                el.cancelComparisonCustomizeBtn.addEventListener('click', closeComparisonCustomizeModal);
            }
        }
    </script>
</body>
</html>